<?php
//header('Content-type: application/ms-excel');
//header('Content-Disposition: attachment; filename="reportmaster_excel_'.date("d-m-Y").'.xls"');
?>
<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:x="urn:schemas-microsoft-com:office:excel"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=ProgId content=Excel.Sheet>
<meta name=Generator content="Microsoft Excel 12">
<style>
tr
	{mso-height-source:auto;}
col
	{mso-width-source:auto;}
br
	{mso-data-placement:same-cell;}
.style0
	{mso-number-format:General;
	text-align:general;
	vertical-align:bottom;
	white-space:nowrap;
	mso-rotate:0;
	mso-background-source:auto;
	mso-pattern:auto;
	color:black;
	font-size:11.0pt;
	font-weight:400;
	font-style:normal;
	text-decoration:none;
	font-family:Tahoma, sans-serif;
	mso-font-charset:222;
	border:none;
	mso-protection:locked visible;
	mso-style-name:ปกติ;
	mso-style-id:0;}
td
	{mso-style-parent:style0;
	padding-top:1px;
	padding-right:1px;
	padding-left:1px;
	mso-ignore:padding;
	color:black;
	font-size:11.0pt;
	font-weight:400;
	font-style:normal;
	text-decoration:none;
	font-family:Tahoma, sans-serif;
	mso-font-charset:222;
	mso-number-format:General;
	text-align:general;
	vertical-align:bottom;
	border:none;
	mso-background-source:auto;
	mso-pattern:auto;
	mso-protection:locked visible;
	white-space:nowrap;
	mso-rotate:0;}
.xl65
	{mso-style-parent:style0;
	font-size:10.0pt;
	font-family:Arial, sans-serif;
	mso-font-charset:0;}
.xl66
	{mso-style-parent:style0;
	font-size:9.0pt;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	vertical-align:top;
	border:.5pt solid windowtext;
	white-space:normal;}
.xl67
	{mso-style-parent:style0;
	font-size:10.0pt;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	border:.5pt solid windowtext;}
.xl68
	{mso-style-parent:style0;
	font-size:9.0pt;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	mso-number-format:"\@";
	text-align:left;
	vertical-align:top;
	border:.5pt solid windowtext;}
.xl69
	{mso-style-parent:style0;
	font-size:9.0pt;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	mso-number-format:Standard;
	border:.5pt solid windowtext;}
.xl70
	{mso-style-parent:style0;
	font-size:10.0pt;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	text-align:center;
	border-top:none;
	border-right:none;
	border-bottom:.5pt solid windowtext;
	border-left:none;}
.xl71
	{mso-style-parent:style0;
	font-weight:700;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	text-align:center;}
.xl72
	{mso-style-parent:style0;
	font-size:10.0pt;
	font-weight:700;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	text-align:center;}
.xl73
	{mso-style-parent:style0;
	font-size:9.0pt;
	font-weight:700;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	text-align:center;
	vertical-align:middle;
	border-top:.5pt solid windowtext;
	border-right:none;
	border-bottom:.5pt solid windowtext;
	border-left:.5pt solid windowtext;
	background:#BFBFBF;
	mso-pattern:black none;}
.xl74
	{mso-style-parent:style0;
	font-size:9.0pt;
	font-weight:700;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	text-align:center;
	vertical-align:middle;
	border-top:.5pt solid windowtext;
	border-right:none;
	border-bottom:.5pt solid windowtext;
	border-left:none;
	background:#BFBFBF;
	mso-pattern:black none;}
.xl75
	{mso-style-parent:style0;
	font-size:9.0pt;
	font-weight:700;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	text-align:center;
	vertical-align:middle;
	border-top:.5pt solid windowtext;
	border-right:.5pt solid windowtext;
	border-bottom:.5pt solid windowtext;
	border-left:none;
	background:#BFBFBF;
	mso-pattern:black none;}
.xl76
	{mso-style-parent:style0;
	font-size:9.0pt;
	font-weight:700;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	text-align:center;
	vertical-align:middle;
	border-top:.5pt solid windowtext;
	border-right:.5pt solid windowtext;
	border-bottom:none;
	border-left:.5pt solid windowtext;
	background:#BFBFBF;
	mso-pattern:black none;}
.xl77
	{mso-style-parent:style0;
	font-size:9.0pt;
	font-weight:700;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	text-align:center;
	vertical-align:middle;
	border-top:none;
	border-right:.5pt solid windowtext;
	border-bottom:.5pt solid windowtext;
	border-left:.5pt solid windowtext;
	background:#BFBFBF;
	mso-pattern:black none;}
.xl78
	{mso-style-parent:style0;
	font-size:10.0pt;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	text-align:center;
	border:.5pt solid windowtext;}
.xl79
	{mso-style-parent:style0;
	font-size:9.0pt;
	font-weight:700;
	font-family:Arial, sans-serif;
	mso-font-charset:0;
	border:.5pt solid windowtext;}

<!--table
	{mso-displayed-decimal-separator:"\.";
	mso-displayed-thousand-separator:"\,";}
@page
	{margin:.04in .04in .04in .04in;
	mso-header-margin:.31in;
	mso-footer-margin:.31in;}
-->
</style>
</head>

<body link=blue vlink=purple class=xl65>
<?php
function ShowDate($myDate) {
		if($myDate=="0000-00-00" || $myDate==""){ return "";}
		$myDateArray=explode("-",$myDate);
		$myDay = sprintf("%d",$myDateArray[2]);
		switch($myDateArray[1]) {
			case "01" : $myMonth = "ม.ค.";  break;
			case "02" : $myMonth = "ก.พ.";  break;
			case "03" : $myMonth = "มี.ค."; break;
			case "04" : $myMonth = "เม.ย."; break;
			case "05" : $myMonth = "พ.ค.";   break;
			case "06" : $myMonth = "มิ.ย.";  break;
			case "07" : $myMonth = "ก.ค.";   break;
			case "08" : $myMonth = "ส.ค.";  break;
			case "09" : $myMonth = "ก.ย.";  break;
			case "10" : $myMonth = "ต.ค.";  break;
			case "11" : $myMonth = "พ.ย.";  break;
			case "12" : $myMonth = "ธ.ค.";  break;
		}
		$myYear = sprintf("%d",$myDateArray[0])+543;
        return($myDay . " " . $myMonth . " " . substr($myYear,2));
}
$myServer = "localhost";
$myUser = "root";
$myPass = "go11co11";

// $myUser = "root1";
// $myPass = "1234";

$db_ksp ="nationalhealth";

$dbhandle = mysql_connect($myServer, $myUser, $myPass)or die("Couldn't connect to SQL Server on $myServer");
$selected = mysql_select_db($db_ksp, $dbhandle)or die("Couldn't open database $myDB");
mysql_query("SET character_set_results=tis620");
mysql_query("SET character_set_client=tis620");
mysql_query("SET character_set_connection=tis620");
?>
<table border=0 cellpadding=0 cellspacing=0 width=759 style='border-collapse:
 collapse;table-layout:fixed;width:568pt'>
 <col class=xl65 width=55 style='mso-width-source:userset;mso-width-alt:1760;
 width:41pt'>
 <col class=xl65 width=206 style='mso-width-source:userset;mso-width-alt:6592;
 width:155pt'>
 <col class=xl65 width=83 span=6 style='mso-width-source:userset;mso-width-alt:
 2656;width:62pt'>
 <tr height=20 style='height:15.0pt'>
  <td colspan=8 height=20 class=xl71 width=593 style='height:15.0pt;width:444pt'>สำนักงานคณะกรรมการสุขภาพแห่งชาติ
  สนง. คณะกรรมการสุขภาพแห่งชาติ</td>
 </tr>
 <tr height=20 style='height:15.0pt'>
  <td colspan=8 height=20 class=xl71 style='height:15.0pt'>งบทดลอง</td>
 </tr>
 <tr height=17 style='height:12.75pt'>
  <td colspan=8 height=17 class=xl72 style='height:12.75pt'>สำหรับรายการตั้งแต่บัญชี่เลขที่
  <?php echo $_REQUEST["ac1"]; ?> ถึง <?php echo $_REQUEST["ac2"]; ?> ในช่วงวันที่ <?php echo ShowDate($_REQUEST["st"]); ?> ถึง <?php echo ShowDate($_REQUEST["ed"]); ?></td>
 </tr>
 <tr height=17 style='height:12.75pt'>
  <td colspan=6 height=17 class=xl70 style='height:12.75pt'>&nbsp;</td>
  <td colspan=2 class=xl65 style='mso-ignore:colspan'></td>
 </tr>
 <tr height=21 style='mso-height-source:userset;height:15.75pt'>
  <td rowspan=2 height=42 class=xl76 style='border-bottom:.5pt solid black;
  height:31.5pt;border-top:none'>รหัสบัญชี</td>
  <td rowspan=2 class=xl76 style='border-bottom:.5pt solid black;border-top:
  none'>ชื่อบัญชี</td>
  <td colspan=2 class=xl73 style='border-right:.5pt solid black;border-left:
  none'>ยอดยกมา</td>
  <td colspan=2 class=xl73 style='border-right:.5pt solid black;border-left:
  none'>ยอดประจำงวด</td>
  <td colspan=2 class=xl73 style='border-right:.5pt solid black;border-left:
  none'>ยอดสะสม</td>
 </tr>
 <tr height=21 style='mso-height-source:userset;height:15.75pt'>
  <td height=21 class=xl73 style='height:15.75pt;border-top:none;border-left:
  none'>เดบิต</td>
  <td class=xl74 style='border-top:none'>เครดิต</td>
  <td class=xl74 style='border-top:none'>เดบิต</td>
  <td class=xl75 style='border-top:none'>เครดิต</td>
  <td class=xl74 style='border-top:none'>เดบิต</td>
  <td class=xl75 style='border-top:none'>เครดิต</td>
 </tr>
<?php
$sql = "SELECT AcGroupId,AcChartId,AcChartCode,ThaiName,Dr,Cr FROM `ac_chart` WHERE `AcChartCode`>= ".$_REQUEST["ac1"]." and `AcChartCode`<=".$_REQUEST["ac2"]." and `AcType`='D' and EnableStatus='Y' and DeleteStatus='N'";
$result =mysql_query($sql);
$sd1=0;$sc1=0;$sd2=0;$sc2=0;$sd3=0;$sc3=0;
while ($row = mysql_fetch_array($result)){		// Loop ชื่อบัญชี Start
	$sql1 = "SELECT SUM(t1.DrValue) as Drsum FROM ac_action_detail as t1 inner join ac_action as t2 on t1.AcActionId=t2.AcActionId WHERE t1.DrId=".$row["AcChartId"]." and ActionDate<'".$_REQUEST["st"]."'";
	$AcGroupId = $row["AcGroupId"];
	$result_drsum =mysql_query($sql1);
	$Drsum = 0;
    if ($rowdr = mysql_fetch_array($result_drsum)){
        $Drsum = $rowdr["Drsum"];
    }
    $Drsum = $Drsum + $row["Dr"];
	$sql2 = "SELECT SUM(t1.CrValue) as Crsum FROM ac_action_detail as t1 inner join ac_action as t2 on t1.AcActionId=t2.AcActionId WHERE t1.DrId=".$row["AcChartId"]." and ActionDate<'".$_REQUEST["st"]."'";
	$Crsum = 0;
	$result_crsum =mysql_query($sql2);
    if ($rowcr = mysql_fetch_array($result_crsum)){
        $Crsum = $rowcr["Crsum"];
    }
    $Crsum = $Crsum + $row["Cr"];
    $TotalCD = $Drsum-$Crsum;
    $inD=0;
    $inC=0;
    if($AcGroupId==1 || $AcGroupId==5 || $AcGroupId==6){
    	if($TotalCD>0){
    		$inD = $TotalCD;
    	}else{
    		$inC = 0-$TotalCD;
    	}
    }else{
    	if($TotalCD>0){
    		$inC = $TotalCD;
    	}else{
    		$inD = 0-$TotalCD;
    	}    
    }
    $sd1=$sd1+$inD;
    $sc1=$sc1+$inC;
?>
 <tr height=17 style='height:12.75pt'>
  <td height=17 class=xl68 style='height:12.75pt;border-top:none'><?php echo iconv("tis-620","utf-8",$row["AcChartCode"]);?></td>
  <td class=xl66 align=left width=206 style='border-top:none;border-left:none;
  width:155pt'><?php echo iconv("tis-620","utf-8",$row["ThaiName"]);?></td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php if($inD!=0){echo number_format($inD,2);}?></td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php if($inC!=0){echo number_format($inC,2);}?></td>
<?php
	$sqlitem = "SELECT t2.ActionDate,t2.PV,t2.PostStatus,t1.DrValue,t1.CrValue,(t1.DrValue-t1.CrValue) as total,t3.DetailCostAccount,t3.DocCode FROM (ac_action_detail as t1 inner join ac_action as t2 on t1.AcActionId=t2.AcActionId) left join tblfinance_payment_list_detail as t3 on t1.PaymentListDetailId=t3.PaymentListDetailId WHERE (t1.DrId=".$row["AcChartId"]." or t1.CrId=".$row["AcChartId"].") and ActionDate>='".$_REQUEST["st"]."' and ActionDate<='".$_REQUEST["ed"]."' order by t2.ActionDate ASC";
	$resultitem =mysql_query($sqlitem);
	$ditem_sum = 0;
	$citem_sum = 0;
	$titem_sum = 0;
		$dn =0;
		$cn =0;
	while ($rowi = mysql_fetch_array($resultitem)){		// Loop รายการบัญชี Start
		if($AcGroupId==1 || $AcGroupId==5 || $AcGroupId==6){
			$TotalCD = $TotalCD+$rowi["total"];
		}else{
			$TotalCD = $TotalCD-$rowi["total"];
		}
		$DocCode = $rowi["DocCode"];
		$ActCode = "";
		if($DocCode){
			$sqlact = "SELECT PrjActCode FROM tblfinance_doccode WHERE DocCode='".$DocCode."'";
			$result_act =mysql_query($sqlact);
		    if ($rowa = mysql_fetch_array($result_act)){
		        $ActCode = $rowa["PrjActCode"];
		    }
		}
		$ditem_sum = $ditem_sum + $rowi["DrValue"];
		$citem_sum = $citem_sum + $rowi["CrValue"];
		$titem_sum = $titem_sum + $rowi["total"];
		$sd2 = $sd2 + $ditem_sum;
		$sc2 = $sc2 + $citem_sum;
		if($AcGroupId==1 || $AcGroupId==5 || $AcGroupId==6){
			if($TotalCD>0){
				$dn = $TotalCD;
			}else{
				$cn = abs($TotalCD);
			}
		}else{
			if($TotalCD>0){
				$cn = $TotalCD;
			}else{
				$dn = abs($TotalCD);
			}
		}
		$sd3 = $sd3 + $dn;
		$sc3 = $sc3 + $cn;
	}
?>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php if($ditem_sum!=0){echo number_format($ditem_sum,2);}?></td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php if($citem_sum!=0){echo number_format($citem_sum,2);}?></td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php if($dn!=0){echo number_format($dn,2);}?></td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php if($cn!=0){echo number_format($cn,2);}?></td>
 </tr>
<?php
}
?>
 <tr height=17 style='height:12.75pt'>
  <td height=17 class=xl67 style='height:12.75pt;border-top:none'>&nbsp;</td>
  <td class=xl79 align=left style='border-top:none;border-left:none'>รวมทั้งสิ้น</td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php echo number_format($sd1,2);?></td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php echo number_format($sc1,2);?></</td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php echo number_format($sd2,2);?></td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php echo number_format($sc2,2);?></td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php echo number_format($sd3,2);?></td>
  <td class=xl69 align=right style='border-top:none;border-left:none'><?php echo number_format($sc3,2);?></td>
 </tr>
 <tr height=4 style='mso-height-source:userset;height:3.0pt'>
  <td colspan=8 height=4 class=xl78 style='height:3.0pt'>&nbsp;</td>
 </tr>
</table>

</body>

</html>
